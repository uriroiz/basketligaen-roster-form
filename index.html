<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basketligaen Team Roster Submission Form ‚Äì Pixellot Advantage</title>
  <meta name="description" content="Basketligaen roster submission with multi-step form, progress tracking, and bulk operations." />

  <!--
    ============================
    Version History (high-level)
    ============================
    3.23.6  ‚Äì FIX: Email typo helper no longer suggests ".dkk" for valid ".dk".
              Tightened suggestion rules to only operate on final TLD or known provider typos.
              Removed overly broad '.d' ‚Üí '.dk' rule.
    3.23.5  ‚Äì Previous public version (had the '.d' ‚Üí '.dk' bug).
  -->

  <style>
    :root {
      --bg: #f8fafc; --bg-2: #e2e8f0; --card: #ffffff; --ink: #1e293b; --ink-2: #374151;
      --muted: #64748b; --brand: #3b82f6; --brand-600: #2563eb; --ok: #10b981; --ok-600: #059669;
      --warn: #f59e0b; --err: #ef4444; --err-bg: #fef2f2; --err-brd: #fecaca; --ring: rgba(59,130,246,.12); --brd: #e2e8f0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; padding: 20px; min-height: 100vh; background: linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--ink); }
    
    .container { max-width: 1200px; margin: 0 auto; background: var(--card); border: 1px solid var(--brd); border-radius: 12px; padding: 32px;
      box-shadow: 0 4px 6px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.06); }
    
    h1 { font-size: clamp(1.8rem, 2.2vw, 2.5rem); font-weight: 800; text-align: center; margin: 0 0 6px; }
    .subtitle { text-align: center; color: var(--muted); margin-bottom: 14px; }
    .version-info { text-align: center; margin-bottom: 24px; font-size: .95rem; color: var(--muted); }
    .version { background: var(--brand); color: #fff; padding: 4px 12px; border-radius: 16px; font-weight: 700; margin-right: 10px; box-shadow: 0 1px 3px rgba(59,130,246,.3); }

    /* Progress Bar */
    .progress-container { margin-bottom: 32px; }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand), var(--brand-600)); transition: width 0.3s ease; border-radius: 4px; }
    
    .steps { display: flex; justify-content: space-between; margin-bottom: 16px; gap: 16px; }
    .step { display: flex; align-items: center; flex: 1; justify-content: center; }
    .step-circle { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; margin-right: 8px; position: relative; z-index: 1; }
    .step.pending .step-circle { background: #e5e7eb; color: var(--muted); }
    .step.active .step-circle { background: var(--brand); color: white; }
    .step.completed .step-circle { background: var(--ok); color: white; }
    .step-label { font-size: 14px; font-weight: 600; }
    .step.pending .step-label { color: var(--muted); }
    .step.active .step-label { color: var(--brand); }
    .step.completed .step-label { color: var(--ok); }

    /* Form Steps */
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .form-section { margin-bottom: 24px; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid var(--brd); }
    .form-section h2 { font-size: 1.15rem; font-weight: 700; margin: 0 0 14px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-12 { grid-column: 1 / -1; }
    label { display: block; font-weight: 700; color: var(--ink-2); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; background: #fff; }
    input:focus, select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }

    .roster-section { margin-bottom: 28px; }
    .roster-section h2 { font-size: 1.35rem; font-weight: 800; margin: 0 0 14px; position: relative; }
    .roster-section h2::after { content: ""; position: absolute; bottom: -6px; left: 0; width: 90px; height: 3px; background: var(--brand); }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
    th { background: #f8fafc; color: #374151; padding: 12px 10px; text-align: left; font-size: .8rem; text-transform: uppercase; letter-spacing: .4px; border-bottom: 2px solid #e5e7eb; }
    td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; } tr:nth-child(even) { background: #fbfcff; }
    .staff-row { background: #f0f9ff !important; }
    .jersey-input { text-align: center; font-weight: 700; }
    .duplicate { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Inline field error */
    .field-error { display:none; margin-top:6px; padding:10px 12px; border-radius:8px;
      background: var(--err-bg); border:1px solid var(--err-brd); color:#991b1b; font-weight:600; font-size:.9rem; }
    .input-error { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Bulk Operations */
    .bulk-ops { margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 12px; }
    .bulk-ops h3 { margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #0369a1; display: flex; align-items: center; gap: 8px; }
    
    .bulk-workflow { display: flex; gap: 24px; align-items: flex-start; margin-bottom: 16px; }
    .bulk-step { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
    .step-number { width: 28px; height: 28px; background: var(--brand); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; margin-top: 4px; }
    .step-content { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .step-content label { font-size: 14px; font-weight: 600; color: #1e40af; margin: 0; }
    .step-content small { color: #64748b; font-size: 12px; line-height: 1.3; }
    
    .bulk-select-all { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .bulk-select-all input { width: auto; margin: 0; }
    
    .bulk-select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; width: 100%; }
    .bulk-step .btn { margin-right: 8px; margin-bottom: 4px; padding: 8px 16px; font-size: 14px; }
    
    .bulk-status { padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; text-align: center; }
    .bulk-status span { font-weight: 600; color: var(--brand); }
    
    .selected-row { background-color: #dbeafe !important; border-left: 4px solid var(--brand) !important; }

    .status { display: none; padding: 12px 14px; border-radius: 10px; margin-bottom: 12px; font-weight: 600; }
    .status--warn { background: var(--err-bg); color: #991b1b; border: 1px solid var(--err-brd); }
    .status--ok { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

    .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn { padding: 12px 18px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: transform .12s ease, background .12s ease, opacity .12s ease; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-primary { background: var(--brand); color: #fff; } .btn-primary:hover:not(:disabled) { background: var(--brand-600); transform: translateY(-1px); }
    .btn-secondary { background: #6b7280; color: #fff; } .btn-secondary:hover:not(:disabled) { background: #4b5563; transform: translateY(-1px); }
    .btn-success { background: var(--ok); color: #fff; } .btn-success:hover:not(:disabled) { background: var(--ok-600); transform: translateY(-1px); }
    .btn-outline { background: transparent; color: var(--ink-2); border: 1px solid var(--brd); }

    .loading { display: none; text-align: center; color: var(--brand); font-weight: 800; margin-top: 10px; }
    .table-tools { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }

    .step-navigation { display: flex; justify-content: space-between; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--brd); }

    @media (max-width: 900px) {
      .col-6, .col-4, .col-3 { grid-column: 1 / -1; }
      .container { padding: 18px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
      .bulk-workflow { flex-direction: column; gap: 16px; }
      .bulk-step { flex-direction: row; align-items: center; }
      .step-content { margin-left: 8px; }
      .steps { flex-direction: column; gap: 8px; }
      .step::after { display: none; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>üèÄ Basketligaen Team Roster Submission</h1>
    <p class="subtitle">Official roster form for Basketligaen teams ‚Ä¢ Powered by Pixellot Advantage</p>

    <div class="version-info" aria-live="polite">
      <span id="versionBadge" class="version">Version 3.23.6</span>
      <span class="date">Updated: August 2025</span>
      <div style="margin-top:6px;font-size:12px;color:#64748b">
        Latest change: fixed email validator for Danish domains (.dk).
      </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 25%"></div>
      </div>
      <div class="steps">
        <div class="step active" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">Team Info</div>
        </div>
        <div class="step pending" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">Players</div>
        </div>
        <div class="step pending" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">Staff</div>
        </div>
        <div class="step pending" data-step="4">
          <div class="step-circle">4</div>
          <div class="step-label">Review</div>
        </div>
      </div>
    </div>

    <form id="rosterForm" novalidate>
      <!-- Step 1: Team Information -->
      <div class="form-step active" data-step="1">
        <section class="form-section" aria-labelledby="team-info-h">
          <h2 id="team-info-h">üèÜ Team Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="teamName">Team Name</label>
              <input id="teamName" name="teamName" type="text" placeholder="Enter your team name" autocomplete="organization" required />
            </div>
            <div class="col-6" style="display: none;">
              <label for="league">League</label>
              <select id="league" name="league">
                <option value="Basketligaen" selected>Basketligaen</option>
              </select>
            </div>
            <div class="col-6">
              <label for="season">Season</label>
              <select id="season" name="season" required></select>
            </div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="contact-h">
          <h2 id="contact-h">üìù Contact Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="submitterName">Your Name</label>
              <input id="submitterName" name="submitterName" type="text" placeholder="Enter your full name" autocomplete="name" required />
            </div>
            <div class="col-6">
              <label for="submitterEmail">Your Email</label>
              <input id="submitterEmail" name="submitterEmail" type="email" placeholder="Enter your email address" autocomplete="email" inputmode="email" required />
              <!-- Inline error for submitter email -->
              <div id="submitterEmailError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Step 2: Players -->
      <div class="form-step" data-step="2">
        <section class="roster-section" aria-labelledby="players-h">
          <h2 id="players-h">üéØ Player Roster</h2>
          <div id="dupWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
          <div id="emailWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
          
          <!-- Bulk Operations -->
          <div class="bulk-ops">
            <h3>‚ö° Bulk Operations</h3>
            <div class="bulk-workflow">
              <div class="bulk-step">
                <span class="step-number">1</span>
                <div class="step-content">
                  <label class="bulk-select-all">
                    <input type="checkbox" id="selectAllPlayers">
                    <strong>Select Players</strong>
                  </label>
                  <small>Check individual players below or use "Select All"</small>
                </div>
              </div>
              
              <div class="bulk-step">
                <span class="step-number">2</span>
                <div class="step-content">
                  <label for="bulkPosition"><strong>Choose Position</strong></label>
                  <select id="bulkPosition" class="bulk-select">
                    <option value="">Choose position to apply...</option>
                    <option value="G">üèÉ‚Äç‚ôÇÔ∏è Guard (G)</option>
                    <option value="F">üèÄ Forward (F)</option>
                    <option value="C">üè¢ Center (C)</option>
                  </select>
                </div>
              </div>
              
              <div class="bulk-step">
                <span class="step-number">3</span>
                <div class="step-content">
                  <button type="button" class="btn btn-primary" id="applyBulkPosition">
                    ‚ú® Apply Position
                  </button>
                  <button type="button" class="btn btn-outline" id="clearSelected">
                    üóëÔ∏è Clear Selection
                  </button>
                </div>
              </div>
            </div>
            
            <div id="bulkStatus" class="bulk-status">
              <span id="selectionCount">0 players selected</span>
            </div>
          </div>

          <div class="table-tools">
            <button type="button" class="btn btn-outline" id="addRowBtn">+ Add Player</button>
            <button type="button" class="btn btn-outline" id="removeRowBtn">‚àí Remove Last</button>
            <span id="rowCountHelp" class="subtitle" aria-live="polite">0 rows</span>
          </div>
          
          <table aria-describedby="rowCountHelp">
            <thead>
              <tr>
                <th style="width:40px">Select</th>
                <th style="width:64px">S/N</th>
                <th style="width:90px">Jersey #</th>
                <th style="min-width:160px">First Name</th>
                <th style="min-width:160px">Last Name</th>
                <th style="width:90px">Height (CM)</th>
                <th style="width:100px">Position</th>
                <th style="min-width:220px">Email Address</th>
              </tr>
            </thead>
            <tbody id="playersTable"></tbody>
          </table>
        </section>
      </div>

      <!-- Step 3: Staff -->
      <div class="form-step" data-step="3">
        <section class="roster-section" aria-labelledby="staff-h">
          <h2 id="staff-h">üë®‚Äçüíº Coaching Staff</h2>
          <table>
            <thead>
              <tr>
                <th style="width:64px">S/N</th>
                <th style="width:140px">Role</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th style="width:100px">Position</th>
                <th>Email Address</th>
                <th style="width:140px">Phone</th>
              </tr>
            </thead>
            <tbody>
              <tr class="staff-row">
                <td>17</td>
                <td><strong>Head Coach</strong></td>
                <td><input type="text" name="coach_first" placeholder="First name" required /></td>
                <td><input type="text" name="coach_last" placeholder="Last name" required /></td>
                <td>-</td>
                <td><input type="email" name="coach_email" placeholder="Email" required /></td>
                <td><input type="tel" name="coach_phone" placeholder="Phone" inputmode="tel" required /></td>
              </tr>
              <tr class="staff-row">
                <td>18</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst1_first" placeholder="First name" /></td>
                <td><input type="text" name="asst1_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst1_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst1_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>19</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst2_first" placeholder="First name" /></td>
                <td><input type="text" name="asst2_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst2_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst2_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>20</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst3_first" placeholder="First name" /></td>
                <td><input type="text" name="asst3_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst3_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst3_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>21</td>
                <td><strong>GM</strong></td>
                <td><input type="text" name="gm_first" placeholder="First name" /></td>
                <td><input type="text" name="gm_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="gm_email" placeholder="Email" /></td>
                <td><input type="tel" name="gm_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>

      <!-- Step 4: Review -->
      <div class="form-step" data-step="4">
        <section class="form-section">
          <h2>üìã Review Your Submission</h2>
          <div id="reviewContent"></div>
        </section>
      </div>

      <!-- Navigation Buttons -->
      <div class="step-navigation">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">‚Üê Previous</button>
        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear Form</button>
          <button type="button" class="btn btn-outline" id="saveBtn">üíæ Save Draft</button>
          <button type="button" class="btn btn-outline" id="restoreBtn">‚Ü© Restore Draft</button>
          <button type="button" class="btn btn-success" id="newBtn" style="display:none">üìã Create New Roster</button>
        </div>
        <button type="button" class="btn btn-primary" id="nextBtn">Next ‚Üí</button>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">üöÄ Submit Roster</button>
      </div>

      <div id="loading" class="loading">üîÑ Submitting your roster...</div>
      <div id="okMsg" class="status status--ok" role="status" aria-live="polite">‚úÖ Action complete.</div>
    </form>
  </div>

  <script>
    // === Configuration ===
    const EmailJSConfig = Object.freeze({
      publicKey: "_r4Y7hg0AGi5DhIcF",
      serviceId: "service_4bdvcf9",
      templateId: "template_6o8secn"
    });

    const DATA_SINK_URL = 'https://script.google.com/macros/s/AKfycbxchgyxazvH9t4N0prpLTboqeAlb6kRz6xUj-klQ1HIYtrZjs9qeKxWVqTttVJKdREj/exec';
    const DATA_SINK_KEY = 'Pixellot2@25';

    const APP_VERSION = '3.23.6';
    const BUILD_DATE = new Date().toISOString().slice(0,10);

    const CURRENT_SEASON_START_YEAR = 2025;
    const NEXT_SEASON_START_YEAR = 2026;
    const SWITCHOVER_DATE = new Date(2026, 7, 1);
    const FORCE_EXPOSE_NEXT_SEASON = false;

    const DEFAULT_PLAYER_ROWS = 16;
    const HARD_MAX_PLAYERS = 40;
    const STORAGE_KEY = "basketligaenRosterDraft_v3236";

    // === Multi-Step Navigation ===
    let currentStep = 1;
    const totalSteps = 4;

    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed', 'pending');
        
        if (stepNum < currentStep) {
          step.classList.add('completed');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else if (stepNum === currentStep) {
          step.classList.add('active');
          step.querySelector('.step-circle').textContent = stepNum;
        } else {
          step.classList.add('pending');
          step.querySelector('.step-circle').textContent = stepNum;
        }
      });
    }

    function showStep(step) {
      document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
      document.querySelector('.form-step[data-step="' + step + '"]').classList.add('active');
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.style.display = step > 1 ? 'block' : 'none';
      nextBtn.style.display = step < totalSteps ? 'block' : 'none';
      submitBtn.style.display = step === totalSteps ? 'block' : 'none';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (step === 4) {
        updateReviewContent();
      }
    }

    // === Robust Email Validation with safe typo suggestions (supports .dk) ===
    function emailValid(email) {
      const e = (email || '').trim().toLowerCase();
      if (!e) return { ok: true };

      // Basic RFC-like shape
      const basic = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
      if (!basic) return { ok: false };

      // Split
      const [local, domain] = e.split('@');
      if (!local || !domain) return { ok: false };

      // Domain pieces checks
      const labels = domain.split('.');
      if (labels.length < 2) return { ok: false };

      // Each label 1‚Äì63 chars, start/end alnum, hyphens allowed inside
      for (let i = 0; i < labels.length; i++) {
        const L = labels[i];
        if (!/^[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?$/.test(L)) return { ok: false };
      }

      const tld = labels[labels.length - 1];

      // TLD must be >= 2 chars (so .dk is fine)
      if (tld.length < 2) return { ok: false };

      // Known TLD typos ‚Äì apply ONLY to the final TLD
      const tldTypos = {
        'con': 'com', 'cmo': 'com', 'ocm': 'com', 'cpm': 'com', 'comm': 'com',
        'ddk': 'dk',  'dkk': 'dk' // only suggest to .dk, never from .dk to .dkk
      };
      if (tldTypos[tld]) {
        const suggestion = e.replace(/\.[^.]+$/, '.' + tldTypos[tld]);
        return { ok: false, suggestion };
      }

      // Popular provider typos ‚Äì fix only once and only when they are clear
      const providerTypos = [
        { rx: /^gamil\./, rep: 'gmail.' },
        { rx: /^gmial\./, rep: 'gmail.' },
        { rx: /^gmai\./, rep: 'gmail.' },
        { rx: /^outlok\./, rep: 'outlook.' },
        { rx: /^yahooo\./, rep: 'yahoo.' },
        { rx: /^hotmial\./, rep: 'hotmail.' }
      ];
      for (let i = 0; i < providerTypos.length; i++) {
        if (providerTypos[i].rx.test(domain)) {
          const suggestion = `${local}@${domain.replace(providerTypos[i].rx, providerTypos[i].rep)}`;
          return { ok: false, suggestion };
        }
      }

      // Reject obvious structural issues
      if (e.includes('..') || e.includes('@.') || e.includes('.@')) return { ok: false };

      return { ok: true };
    }

    function formatEmail(email) {
      if (!email) return '';
      return email.trim().toLowerCase();
    }

    // === Inline error helpers ===
    function showFieldError(inputEl, msg, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = msg;
        box.style.display = 'block';
      }
      if (inputEl) {
        inputEl.classList.add('input-error');
        inputEl.setAttribute('aria-invalid', 'true');
      }
    }

    function clearFieldError(inputEl, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = '';
        box.style.display = 'none';
      }
      if (inputEl) {
        inputEl.classList.remove('input-error');
        inputEl.removeAttribute('aria-invalid');
      }
    }

    // === Danish Character Normalization + Name Utils ===
    function normalizeDanish(str="") {
      return str
        .replace(/[√¶√Ü]/g, m => m === '√Ü' ? 'AE' : 'ae')
        .replace(/[√∏√ò]/g, m => m === '√ò' ? 'OE' : 'oe')
        .replace(/[√•√Ö]/g, m => m === '√Ö' ? 'AA' : 'aa')
        .replace(/[√§√Ñ]/g, m => m === '√Ñ' ? 'AE' : 'ae')
        .replace(/[√∂√ñ]/g, m => m === '√ñ' ? 'OE' : 'oe')
        .replace(/[√´√ã]/g, m => m === '√ã' ? 'E' : 'e')
        .replace(/[√º√ú]/g, m => m === '√ú' ? 'U' : 'u')
        .replace(/[√Ø√è]/g, m => m === '√è' ? 'I' : 'i');
    }
    
    function ucWords(str="") { 
      const normalized = normalizeDanish(str);
      return normalized.toLowerCase().replace(/\b\w/g, ch => ch.toUpperCase()); 
    }
    function clean(s){ return (s ?? '').toString().trim(); }
    function ucName(s){ return ucWords(clean(s)); }

    function leagueToEnglish(h) {
      return 'Basketligaen';
    }

    function positionToFullName(pos) {
      const map = { 'G': 'Guard', 'F': 'Forward', 'C': 'Center' };
      return map[pos] || pos;
    }

    function seasonLabel(fromYear) {
      const toYear = (fromYear + 1).toString().slice(-2);
      return `${fromYear}/${toYear}`;
    }

    function populateSeasonSelect() {
      const sel = document.getElementById('season');
      sel.innerHTML = '';
      const seasons = [CURRENT_SEASON_START_YEAR];
      const exposeNext = FORCE_EXPOSE_NEXT_SEASON || (new Date() >= SWITCHOVER_DATE);
      if (exposeNext) seasons.push(NEXT_SEASON_START_YEAR);
      
      for (let i = 0; i < seasons.length; i++) {
        const y = seasons[i];
        const opt = document.createElement('option');
        opt.value = y + '-' + (y + 1);
        opt.textContent = seasonLabel(y);
        sel.appendChild(opt);
      }
      
      if (seasons.length > 0) {
        const def = exposeNext ? NEXT_SEASON_START_YEAR : CURRENT_SEASON_START_YEAR;
        sel.value = def + '-' + (def + 1);
      }
    }

    function bumpRowCount() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      document.getElementById('rowCountHelp').textContent = rows + ' rows (max ' + HARD_MAX_PLAYERS + ')';
    }

    // === Player Table Functions with Height Column ===
    function playerRowTemplate(idx) {
      const sn = String(idx).padStart(2, '0');
      return '<tr data-player-row="' + idx + '">' +
        '<td><input type="checkbox" class="player-select" data-player="' + idx + '" /></td>' +
        '<td><strong>' + sn + '</strong></td>' +
        '<td><input type="number" min="0" max="99" step="1" name="player' + idx + '_jersey" class="jersey-input" placeholder="#" inputmode="numeric" /></td>' +
        '<td><input type="text" name="player' + idx + '_first" placeholder="First name" /></td>' +
        '<td><input type="text" name="player' + idx + '_last" placeholder="Last name" /></td>' +
        '<td><input type="number" min="100" max="999" step="1" name="player' + idx + '_height" placeholder="CM" inputmode="numeric" class="jersey-input" /></td>' +
        '<td><select name="player' + idx + '_position">' +
          '<option value="">-</option>' +
          '<option value="G">G</option>' +
          '<option value="F">F</option>' +
          '<option value="C">C</option>' +
        '</select></td>' +
        '<td><input type="email" name="player' + idx + '_email" placeholder="Email (optional)" /></td>' +
        '</tr>';
    }

    function ensureRows(count) {
      const tbody = document.getElementById('playersTable');
      tbody.innerHTML = '';
      const n = Math.min(HARD_MAX_PLAYERS, Math.max(1, count || 0));
      for (let i = 1; i <= n; i++) {
        tbody.insertAdjacentHTML('beforeend', playerRowTemplate(i));
      }
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      bumpRowCount();
    }

    function addRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr >= HARD_MAX_PLAYERS) return;
      tbody.insertAdjacentHTML('beforeend', playerRowTemplate(curr + 1));
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      bumpRowCount();
    }

    function removeRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr <= 1) return;
      tbody.removeChild(tbody.lastElementChild);
      bumpRowCount();
      checkDuplicates();
      updateSelectAllState();
    }

    // === Bulk Operations ===
    function hookBulkSelectionListeners() {
      const checkboxes = document.querySelectorAll('.player-select');
      for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].removeEventListener('change', handlePlayerSelectChange);
        checkboxes[i].addEventListener('change', handlePlayerSelectChange);
      }
    }

    function handlePlayerSelectChange() {
      updateRowSelection(this);
      updateSelectAllState();
    }

    function updateRowSelection(checkbox) {
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        row.classList.add('selected-row');
      } else {
        row.classList.remove('selected-row');
      }
    }

    function updateSelectAllState() {
      const allCheckboxes = document.querySelectorAll('.player-select');
      const checkedBoxes = document.querySelectorAll('.player-select:checked');
      const selectAllBox = document.getElementById('selectAllPlayers');
      const statusSpan = document.getElementById('selectionCount');
      
      statusSpan.textContent = checkedBoxes.length + ' player' + (checkedBoxes.length !== 1 ? 's' : '') + ' selected';
      
      if (checkedBoxes.length === 0) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = false;
      } else if (checkedBoxes.length === allCheckboxes.length) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = true;
      } else {
        selectAllBox.indeterminate = true;
        selectAllBox.checked = false;
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllPlayers');
      const checkboxes = document.querySelectorAll('.player-select');
      
      for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = selectAll.checked;
        updateRowSelection(checkboxes[i]);
      }
      
      updateSelectAllState();
    }

    function applyBulkPosition() {
      const selectedPosition = document.getElementById('bulkPosition').value;
      const selectedCheckboxes = document.querySelectorAll('.player-select:checked');
      
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one player first.');
        return;
      }
      
      if (!selectedPosition) {
        alert('Please select a position to apply.');
        return;
      }
      
      for (let i = 0; i < selectedCheckboxes.length; i++) {
        const playerNum = selectedCheckboxes[i].dataset.player;
        const positionSelect = document.querySelector('select[name="player' + playerNum + '_position"]');
        if (positionSelect) {
          positionSelect.value = selectedPosition;
        }
      }
      
      document.getElementById('bulkPosition').value = '';
      flashOk('Applied ' + selectedPosition + ' position to ' + selectedCheckboxes.length + ' player(s).');
    }

    function clearSelected() {
      const checkedBoxes = document.querySelectorAll('.player-select:checked');
      for (let i = 0; i < checkedBoxes.length; i++) {
        checkedBoxes[i].checked = false;
        updateRowSelection(checkedBoxes[i]);
      }
      updateSelectAllState();
    }

    // === Duplicate Detection ===
    let dupTimer;
    function hookDuplicateListeners() {
      const inputs = document.querySelectorAll('input[name*="_jersey"]');
      for (let i = 0; i < inputs.length; i++) {
        inputs[i].removeEventListener('input', dupHandler);
        inputs[i].addEventListener('input', dupHandler);
      }
    }

    function dupHandler() {
      clearTimeout(dupTimer);
      dupTimer = setTimeout(checkDuplicates, 350);
    }

    function normJersey(val){
      const n = parseInt(String(val).trim(), 10);
      return Number.isFinite(n) ? String(n) : '';
    }

    function checkDuplicates() {
      const jerseyInputs = document.querySelectorAll('input[name*="_jersey"]');
      const counts = {};
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v) counts[v] = (counts[v] || 0) + 1;
      });
      
      let hasDup = false;
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v && counts[v] > 1) { inp.classList.add('duplicate'); hasDup = true; }
        else { inp.classList.remove('duplicate'); }
      });
      
      const warn = document.getElementById('dupWarn');
      if (hasDup) {
        warn.style.display = 'block';
        warn.textContent = '‚ö†Ô∏è Duplicate jersey numbers detected. Each player must have a unique number.';
      } else {
        warn.style.display = 'none';
        warn.textContent = '';
      }
    }

    // === Enhanced Validation Helpers ===
    function requireAtLeastOneCompletePlayer() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = document.querySelector('input[name="player' + i + '_jersey"]');
        const first = document.querySelector('input[name="player' + i + '_first"]');
        const last = document.querySelector('input[name="player' + i + '_last"]');
        const pos = document.querySelector('select[name="player' + i + '_position"]');
        const height = document.querySelector('input[name="player' + i + '_height"]');
        
        if (jersey && first && last && pos && height && 
            normJersey(jersey.value) && first.value.trim() && last.value.trim() && pos.value && height.value.trim()) {
          return true;
        }
      }
      return false;
    }

    function validatePlayersCompleteness() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = document.querySelector('input[name="player' + i + '_jersey"]');
        const first = document.querySelector('input[name="player' + i + '_first"]');
        const last = document.querySelector('input[name="player' + i + '_last"]');
        const pos = document.querySelector('select[name="player' + i + '_position"]');
        const height = document.querySelector('input[name="player' + i + '_height"]');
        
        if (jersey && first && last && pos && height) {
          if (first.value.trim()) {
            if (!last.value.trim()) return { row: i, field: 'last name' };
            if (!pos.value) return { row: i, field: 'position' };
            if (!height.value.trim()) return { row: i, field: 'height' };
            if (!normJersey(jersey.value)) return { row: i, field: 'jersey number' };
          }
          const hasAny = normJersey(jersey.value) || first.value.trim() || last.value.trim() || pos.value || height.value.trim();
          const hasRequired = normJersey(jersey.value) && first.value.trim() && last.value.trim() && pos.value && height.value.trim();
          if (hasAny && !hasRequired) return { row: i, field: 'complete player info (jersey, first name, last name, position, height)' };
        }
      }
      return null;
    }

    function validateHeadCoach() {
      const coachFirst = document.querySelector('input[name="coach_first"]');
      const coachLast = document.querySelector('input[name="coach_last"]');
      const coachEmail = document.querySelector('input[name="coach_email"]');
      const coachPhone = document.querySelector('input[name="coach_phone"]');
      
      const hasFirst = coachFirst && coachFirst.value.trim();
      const hasLast = coachLast && coachLast.value.trim();
      const hasEmail = coachEmail && coachEmail.value.trim();
      const hasPhone = coachPhone && coachPhone.value.trim();
      
      if (!hasFirst) return 'Head coach first name is required';
      if (!hasLast) return 'Head coach last name is required';
      if (!hasEmail) return 'Head coach email is required';
      if (!hasPhone) return 'Head coach phone is required';
      
      return null;
    }

    function validateStaffCompleteness() {
      const staffRoles = ['asst1', 'asst2', 'asst3', 'gm'];
      
      for (let i = 0; i < staffRoles.length; i++) {
        const role = staffRoles[i];
        const first = document.querySelector('input[name="' + role + '_first"]');
        const last = document.querySelector('input[name="' + role + '_last"]');
        const email = document.querySelector('input[name="' + role + '_email"]');
        const phone = document.querySelector('input[name="' + role + '_phone"]');
        
        if (first && last && email && phone) {
          const hasFirst = first.value.trim();
          const hasLast = last.value.trim();
          const hasEmail = email.value.trim();
          const hasPhone = phone.value.trim();
          
          const hasAny = hasFirst || hasLast || hasEmail || hasPhone;
          const hasAll = hasFirst && hasLast && hasEmail && hasPhone;
          
          if (hasAny && !hasAll) {
            const roleName = role === 'asst1' ? 'Assistant Coach 1' :
                           role === 'asst2' ? 'Assistant Coach 2' :
                           role === 'asst3' ? 'Assistant Coach 3' : 'General Manager';
            return roleName + ' information is incomplete. All fields (first name, last name, email, phone) are required if any are filled.';
          }
        }
      }
      return null;
    }

    // === Build Roster Data with Sorting ===
    function buildRoster(fd) {
      const teamName = clean(fd.get('teamName'));
      const league = clean(fd.get('league'));
      const season = clean(fd.get('season'));
      const submitterName = ucName(fd.get('submitterName'));
      const submitterEmail = formatEmail(clean(fd.get('submitterEmail')));

      const roster = {
        teamName: teamName,
        league: league,
        leagueEnglish: leagueToEnglish(league),
        submitterName: submitterName,
        submitterEmail: submitterEmail,
        season: season,
        players: [],
        staff: []
      };

      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = normJersey(fd.get('player' + i + '_jersey'));
        const first = ucName(fd.get('player' + i + '_first'));
        const last = ucName(fd.get('player' + i + '_last'));
        const pos = clean(fd.get('player' + i + '_position'));
        const email = formatEmail(clean(fd.get('player' + i + '_email')));
        const height = clean(fd.get('player' + i + '_height'));
        
        if (jersey && first && last && pos) {
          roster.players.push({
            number: i,
            jersey: jersey,
            firstName: first,
            lastName: last,
            position: pos,
            email: email,
            height: height || ''
          });
        }
      }

      roster.players.sort((a, b) => parseInt(a.jersey, 10) - parseInt(b.jersey, 10));

      const staffRoles = [
        { key: 'coach', label: 'Head Coach' },
        { key: 'asst1', label: 'Assistant Coach 1' },
        { key: 'asst2', label: 'Assistant Coach 2' },
        { key: 'asst3', label: 'Assistant Coach 3' },
        { key: 'gm', label: 'General Manager' }
      ];
      
      for (let i = 0; i < staffRoles.length; i++) {
        const role = staffRoles[i];
        const f = ucName(fd.get(role.key + '_first'));
        const l = ucName(fd.get(role.key + '_last'));
        const e = formatEmail(clean(fd.get(role.key + '_email')));
        const p = clean(fd.get(role.key + '_phone'));
        
        if (f && l) {
          roster.staff.push({
            role: role.label,
            firstName: f || '',
            lastName: l || '',
            email: e || '',
            phone: p || ''
          });
        }
      }

      return roster;
    }

    // === Safe Review Renderer ===
    function updateReviewContent() {
      const formData = new FormData(document.getElementById('rosterForm'));
      const roster = buildRoster(formData);
      
      function li(txt) { const el = document.createElement('li'); el.textContent = txt; return el; }

      const root = document.createElement('div');
      root.className = 'grid';
      
      const team = document.createElement('div');
      team.className = 'col-12';
      const h3a = document.createElement('h3'); h3a.textContent = 'üèÜ Team Information';
      team.append(h3a);
      const info = [
        `Team: ${roster.teamName}`,
        `League: ${roster.league} (${roster.leagueEnglish})`,
        `Season: ${seasonLabel(parseInt(roster.season.split('-')[0], 10))}`,
        `Submitted by: ${roster.submitterName}`,
        `Email: ${roster.submitterEmail}`
      ];
      info.forEach(t => { const p = document.createElement('p'); p.textContent = t; team.append(p); });
      
      const players = document.createElement('div');
      players.className = 'col-6';
      const h3b = document.createElement('h3'); h3b.textContent = `üéØ Players (${roster.players.length})`;
      players.append(h3b);
      if (roster.players.length) {
        const ul = document.createElement('ul'); ul.style.margin = 0; ul.style.paddingLeft = '20px';
        roster.players.forEach(p => {
          const heightText = p.height ? ` | Height: ${p.height}` : '';
          const emailText = p.email ? ` | Email: ${p.email}` : '';
          ul.append(li(`#${p.jersey} - Name: ${p.firstName} ${p.lastName} | Position: ${positionToFullName(p.position)}${heightText}${emailText}`));
        });
        players.append(ul);
      } else {
        const em = document.createElement('p'); em.innerHTML = '<em>No players added</em>'; players.append(em);
      }
      
      const staff = document.createElement('div');
      staff.className = 'col-6';
      const h3c = document.createElement('h3'); h3c.textContent = `üë®‚Äçüíº Coaching Staff (${roster.staff.length})`;
      staff.append(h3c);
      if (roster.staff.length) {
        const ul = document.createElement('ul'); ul.style.margin = 0; ul.style.paddingLeft = '20px';
        roster.staff.forEach(s => {
          const parts = [`${s.role}: ${s.firstName} ${s.lastName}`];
          if (s.email) parts.push(s.email);
          if (s.phone) parts.push(s.phone);
          ul.append(li(parts.join(' - ').replace(' - | ', ' | ')));
        });
        staff.append(ul);
      } else {
        const em = document.createElement('p'); em.innerHTML = '<em>No staff added</em>'; staff.append(em);
      }
      
      root.append(team, players, staff);
      const container = document.getElementById('reviewContent');
      container.replaceChildren(root);
    }

    // === Draft Save/Restore ===
    function saveDraft() {
      const data = new FormData(document.getElementById('rosterForm'));
      const obj = { currentStep: currentStep };
      for (const pair of data.entries()) {
        obj[pair[0]] = pair[1];
      }
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        flashOk('Draft saved locally.');
      } catch (e) {
        alert('Failed to save draft. Your browser may have storage restrictions.');
      }
    }

    function restoreDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          alert('No draft found.');
          return;
        }
        
        const obj = JSON.parse(raw);
        
        if (obj.currentStep) {
          currentStep = obj.currentStep;
          showStep(currentStep);
          updateProgress();
        }
        
        const playerKeys = Object.keys(obj).filter(function(k) { return k.indexOf('player') === 0; });
        const maxIdx = Math.max(1, Math.max.apply(Math, playerKeys.map(function(k) {
          const match = k.match(/player(\d+)_/);
          return match ? parseInt(match[1], 10) : 1;
        })));
        
        ensureRows(Math.min(HARD_MAX_PLAYERS, Math.max(DEFAULT_PLAYER_ROWS, maxIdx)));
        
        for (const k in obj) {
          if (k === 'currentStep') continue;
          const el = document.querySelector('[name="' + k + '"]');
          if (el) el.value = obj[k];
        }
        
        bumpRowCount();
        checkDuplicates();
        flashOk('Draft restored.');
      } catch (e) {
        alert('Failed to restore draft. Data may be corrupted.');
      }
    }

    function flashOk(msg) {
      const el = document.getElementById('okMsg');
      el.textContent = '‚úÖ ' + msg;
      el.style.display = 'block';
      setTimeout(function() { el.style.display = 'none'; }, 3000);
    }

    // === Clean CSV Download (No Headers) ===
    function downloadCSV(roster) {
      const BOM = '\uFEFF';
      let csv = '';
      
      for (let i = 0; i < roster.players.length; i++) {
        const p = roster.players[i];
        csv += p.jersey + ',' + p.firstName + ',' + p.lastName + ',' + (p.email || '') + ',' + (p.position || '') + '\n';
      }
      
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'basketligaen_' + roster.teamName.replace(/[^a-z0-9\u0590-\u05FF]/gi, '_').toLowerCase() + '_' + roster.season + '_roster_v' + APP_VERSION + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === Email API ===
    async function sendEmailViaAPI(params, options) {
      const url = 'https://api.emailjs.com/api/v1.0/email/send';
      const payload = {
        service_id: EmailJSConfig.serviceId,
        template_id: EmailJSConfig.templateId,
        user_id: EmailJSConfig.publicKey,
        template_params: params
      };
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: options && options.signal
      });
      if (!res.ok) throw new Error('Email API responded ' + res.status);
      return res;
    }

    // === Data Sink ===
    async function sendToSheet(roster) {
      if (!DATA_SINK_URL) return true;
      
      const url = DATA_SINK_URL + '?key=' + encodeURIComponent(DATA_SINK_KEY);
      const payload = {
        app_version: APP_VERSION,
        build_date: BUILD_DATE,
        season: roster.season,
        team_name: roster.teamName,
        league: roster.league,
        league_english: roster.leagueEnglish,
        submitter_name: roster.submitterName,
        submitter_email: roster.submitterEmail,
        players: roster.players,
        staff: roster.staff
      };
      
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
          return true;
        } catch (e) {
          if (attempt === 3) throw e;
          await new Promise(function(r) { setTimeout(r, 400 * attempt); });
        }
      }
    }

    function rosterSummary(roster) {
      let out = 'BASKETLIGAEN TEAM ROSTER SUBMISSION\n==============================\n';
      out += 'Team: ' + roster.teamName + '\n';
      out += 'League: ' + roster.league + ' (' + roster.leagueEnglish + ')\n';
      out += 'Season: ' + roster.season + '\n';
      out += 'Submitted by: ' + roster.submitterName + '\n';
      out += 'Email: ' + roster.submitterEmail + '\n';
      out += 'Date: ' + new Date().toLocaleString() + '\n';
      out += 'Version: ' + APP_VERSION + '\n\n';
      out += 'CSV FORMAT FOR COPYING:\n=======================\n';
      for (let i = 0; i < roster.players.length; i++) {
        const p = roster.players[i];
        out += p.jersey + ',' + p.firstName + ',' + p.lastName + ',' + (p.email || '') + ',' + (p.position || '') + '\n';
      }
      out += '\nPLAYERS (' + roster.players.length + '):\n------------------------\n';
      for (let i = 0; i < roster.players.length; i++) {
        const p = roster.players[i];
        const heightText = p.height ? ' | Height: ' + p.height : '';
        const emailText = p.email ? ' | Email: ' + p.email : '';
        out += '#' + p.jersey + ' - Name: ' + p.firstName + ' ' + p.lastName + ' | Position: ' + positionToFullName(p.position) + heightText + emailText + '\n';
      }
      out += '\nCOACHING STAFF (' + roster.staff.length + '):\n----------------------------\n';
      for (let i = 0; i < roster.staff.length; i++) {
        const s = roster.staff[i];
        out += s.role + ': ' + s.firstName + ' ' + s.lastName;
        if (s.email) out += ' - ' + s.email;
        if (s.phone) out += ' | ' + s.phone;
        out += '\n';
      }
      return out;
    }

    // === Enhanced Step Validation ===
    function validateCurrentStep() {
      const currentStepEl = document.querySelector('.form-step[data-step="' + currentStep + '"]');
      const requiredFields = currentStepEl.querySelectorAll('[required]');
      
      for (let i = 0; i < requiredFields.length; i++) {
        const field = requiredFields[i];
        if (!field.value.trim()) {
          field.focus();
          field.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return false;
        }
      }
      
      // Step 1: email validation with typo correction
      if (currentStep === 1) {
        const emailField = document.getElementById('submitterEmail');
        const raw = emailField.value;
        clearFieldError(emailField, 'submitterEmailError');

        const { ok, suggestion } = emailValid(raw);
        if (!ok && suggestion) {
          const useCorrection = confirm('Email typo detected!\n\nDid you mean: ' + suggestion + ' ?');
          if (useCorrection) {
            emailField.value = suggestion;
          } else {
            showFieldError(emailField, 'Please correct your email. Suggested: ' + suggestion, 'submitterEmailError');
            emailField.focus();
            emailField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
          }
        } else if (!ok) {
          showFieldError(emailField, 'Please enter a valid email address.', 'submitterEmailError');
          emailField.focus();
          emailField.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return false;
        }
      }
      
      // Step 2: enhanced player validation
      if (currentStep === 2) {
        if (!requireAtLeastOneCompletePlayer()) {
          alert('Please add at least one complete player (jersey, first name, last name, position, height).');
          return false;
        }
        
        const validationError = validatePlayersCompleteness();
        if (validationError) {
          alert('Player #' + validationError.row + ' is missing required ' + validationError.field + '. If a player has a first name, then jersey number, last name, position, and height are all required.');
          return false;
        }
        
        checkDuplicates();
        if (document.getElementById('dupWarn').style.display === 'block') {
          alert('Resolve duplicate jersey numbers before continuing.');
          return false;
        }

        const emailWarn = document.getElementById('emailWarn');
        emailWarn.style.display = 'none';
        emailWarn.textContent = '';

        const playerEmailInputs = document.querySelectorAll('input[name*="player"][name*="_email"]');
        for (let i = 0; i < playerEmailInputs.length; i++) {
          const input = playerEmailInputs[i];
          const v = (input.value || '').trim();
          if (!v) continue;

          const { ok, suggestion } = emailValid(v);
          input.classList.remove('input-error');
          input.removeAttribute('aria-invalid');

          if (!ok && suggestion) {
            const useCorrection = confirm('Player email typo detected!\n\nDid you mean: ' + suggestion + ' ?');
            if (useCorrection) {
              input.value = suggestion;
            } else {
              emailWarn.textContent = 'Please correct player email. Suggested: ' + suggestion;
              emailWarn.style.display = 'block';
              input.classList.add('input-error');
              input.setAttribute('aria-invalid', 'true');
              input.focus();
              input.scrollIntoView({ behavior: 'smooth', block: 'center' });
              return false;
            }
          } else if (!ok) {
            emailWarn.textContent = 'Invalid player email address.';
            emailWarn.style.display = 'block';
            input.classList.add('input-error');
            input.setAttribute('aria-invalid', 'true');
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
          }
        }
      }
      
      // Step 3: comprehensive staff validation
      if (currentStep === 3) {
        const headCoachError = validateHeadCoach();
        if (headCoachError) {
          alert(headCoachError);
          return false;
        }
        
        const staffError = validateStaffCompleteness();
        if (staffError) {
          alert(staffError);
          return false;
        }
        
        // Validate staff email addresses
        const staffEmailInputs = document.querySelectorAll('input[name*="coach_email"], input[name*="asst"][name*="_email"], input[name*="gm_email"]');
        for (let i = 0; i < staffEmailInputs.length; i++) {
          const input = staffEmailInputs[i];
          const v = (input.value || '').trim();
          if (!v) continue;

          const { ok, suggestion } = emailValid(v);
          if (!ok && suggestion) {
            const useCorrection = confirm('Staff email typo detected!\n\nDid you mean: ' + suggestion + ' ?');
            if (useCorrection) {
              input.value = suggestion;
            } else {
              input.focus();
              input.scrollIntoView({ behavior: 'smooth', block: 'center' });
              return false;
            }
          } else if (!ok) {
            alert('Invalid staff email address. Please correct it.');
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
          }
        }
      }
      
      return true;
    }

    function nextStep() {
      if (!validateCurrentStep()) return;
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
        updateProgress();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }

    // === Initialize ===
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('versionBadge').textContent = 'Version ' + APP_VERSION;

      populateSeasonSelect();
      ensureRows(DEFAULT_PLAYER_ROWS);
      updateProgress();
      
      document.getElementById('nextBtn').addEventListener('click', nextStep);
      document.getElementById('prevBtn').addEventListener('click', prevStep);
      document.getElementById('addRowBtn').addEventListener('click', addRow);
      document.getElementById('removeRowBtn').addEventListener('click', removeRow);
      document.getElementById('selectAllPlayers').addEventListener('change', toggleSelectAll);
      document.getElementById('applyBulkPosition').addEventListener('click', applyBulkPosition);
      document.getElementById('clearSelected').addEventListener('click', clearSelected);

      // Clear submitter email error on input & blur validate if needed
      const submitterEmailInput = document.getElementById('submitterEmail');
      submitterEmailInput.addEventListener('input', function() { clearFieldError(this, 'submitterEmailError'); });
      submitterEmailInput.addEventListener('blur', function() {
        const { ok, suggestion } = emailValid(this.value);
        if (!ok && !suggestion) {
          showFieldError(this, 'Please enter a valid email address.', 'submitterEmailError');
        }
      });

      // Clear player email warnings as user edits
      document.addEventListener('input', function(e) {
        if (e.target && e.target.name && e.target.name.endsWith('_email')) {
          e.target.classList.remove('input-error');
          e.target.removeAttribute('aria-invalid');
          const emailWarn = document.getElementById('emailWarn');
          if (emailWarn) { emailWarn.style.display = 'none'; emailWarn.textContent = ''; }
        }
      });

      document.getElementById('clearBtn').addEventListener('click', function() {
        if (!confirm('Clear all data (except your name/email if present)?')) return;
        const keepName = document.getElementById('submitterName').value;
        const keepEmail = document.getElementById('submitterEmail').value;
        document.getElementById('rosterForm').reset();
        ensureRows(DEFAULT_PLAYER_ROWS);
        populateSeasonSelect();
        document.getElementById('submitterName').value = keepName;
        document.getElementById('submitterEmail').value = keepEmail;
        document.getElementById('dupWarn').style.display = 'none';
        document.getElementById('okMsg').style.display = 'none';
        document.getElementById('emailWarn').style.display = 'none';
        document.getElementById('submitterEmailError').style.display = 'none';
        document.getElementById('newBtn').style.display = 'none';
        currentStep = 1;
        showStep(currentStep);
        updateProgress();
      });
      
      document.getElementById('newBtn').addEventListener('click', function() {
        const keepName = document.getElementById('submitterName').value;
        const keepEmail = document.getElementById('submitterEmail').value;
        document.getElementById('rosterForm').reset();
        ensureRows(DEFAULT_PLAYER_ROWS);
        populateSeasonSelect();
        document.getElementById('submitterName').value = keepName;
        document.getElementById('submitterEmail').value = keepEmail;
        document.getElementById('dupWarn').style.display = 'none';
        document.getElementById('okMsg').style.display = 'none';
        document.getElementById('emailWarn').style.display = 'none';
        document.getElementById('submitterEmailError').style.display = 'none';
        document.getElementById('newBtn').style.display = 'none';
        currentStep = 1;
        showStep(currentStep);
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      document.getElementById('saveBtn').addEventListener('click', saveDraft);
      document.getElementById('restoreBtn').addEventListener('click', restoreDraft);

      document.getElementById('rosterForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.currentTarget;
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const ok = document.getElementById('okMsg');
        ok.style.display = 'none';

        const fd = new FormData(form);
        const submitEmail = fd.get('submitterEmail');
        if (submitEmail) {
          const { ok: okEmail, suggestion } = emailValid(submitEmail);
          clearFieldError(document.getElementById('submitterEmail'), 'submitterEmailError');
          if (!okEmail && suggestion) {
            const use = confirm('Did you mean "' + suggestion + '" ?');
            if (use) {
              document.getElementById('submitterEmail').value = suggestion;
            } else {
              showFieldError(document.getElementById('submitterEmail'), 'Please correct your email. Suggested: ' + suggestion, 'submitterEmailError');
              return;
            }
          } else if (!okEmail) {
            showFieldError(document.getElementById('submitterEmail'), 'Please enter a valid email address.', 'submitterEmailError');
            return;
          }
        }

        const roster = buildRoster(fd);
        const params = {
          team_name: roster.teamName,
          league: roster.leagueEnglish,
          submitter_name: roster.submitterName,
          submitter_email: roster.submitterEmail,
          season: roster.season,
          roster_data: rosterSummary(roster)
        };

        submitBtn.disabled = true;
        loading.style.display = 'block';
        const controller = new AbortController();
        const timeout = setTimeout(function() { controller.abort(); }, 15000);

        const sinkPromise = sendToSheet(roster).catch(function(err) {
          console.warn('Data sink error:', err);
          return false;
        });

        try {
          await sendEmailViaAPI(params, { signal: controller.signal });
          await sinkPromise;
          downloadCSV(roster);
          ok.textContent = '‚úÖ Roster submitted successfully. Email sent and CSV downloaded.';
          ok.style.display = 'block';
          document.getElementById('newBtn').style.display = 'inline-block';
        } catch (err) {
          console.error('Email API error:', err);
          alert('Email sending failed. A CSV file will be downloaded instead. Please email it to pixellotibba@gmail.com.');
          downloadCSV(roster);
          ok.textContent = '‚ö†Ô∏è Email failed. CSV downloaded as fallback. Data sink may or may not have succeeded.';
          ok.style.display = 'block';
          document.getElementById('newBtn').style.display = 'inline-block';
        } finally {
          clearTimeout(timeout);
          submitBtn.disabled = false;
          loading.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
