<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basketligaen Team Roster Submission Form ‚Äì Pixellot Advantage</title>
  <meta name="description" content="Basketligaen roster submission with multi-step form, progress tracking, and bulk operations." />

  <style>
    :root {
      --bg: #f8fafc; --bg-2: #e2e8f0; --card: #ffffff; --ink: #1e293b; --ink-2: #374151;
      --muted: #64748b; --brand: #3b82f6; --brand-600: #2563eb; --ok: #10b981; --ok-600: #059669;
      --warn: #f59e0b; --err: #ef4444; --err-bg: #fef2f2; --err-brd: #fecaca; --ring: rgba(59,130,246,.12); --brd: #e2e8f0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; padding: 20px; min-height: 100vh; background: linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--ink); }
    
    .container { max-width: 1200px; margin: 0 auto; background: var(--card); border: 1px solid var(--brd); border-radius: 12px; padding: 32px;
      box-shadow: 0 4px 6px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.06); }
    
    h1 { font-size: clamp(1.8rem, 2.2vw, 2.5rem); font-weight: 800; text-align: center; margin: 0 0 6px; }
    .subtitle { text-align: center; color: var(--muted); margin-bottom: 14px; }
    .version-info { text-align: center; margin-bottom: 24px; font-size: .95rem; color: var(--muted); }
    .version { background: var(--brand); color: #fff; padding: 4px 12px; border-radius: 16px; font-weight: 700; margin-right: 10px; box-shadow: 0 1px 3px rgba(59,130,246,.3); }

    /* Progress Bar */
    .progress-container { margin-bottom: 32px; }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand), var(--brand-600)); transition: width 0.3s ease; border-radius: 4px; }
    
    .steps { display: flex; justify-content: space-between; margin-bottom: 16px; gap: 16px; }
    .step { display: flex; align-items: center; flex: 1; justify-content: center; }
    .step-circle { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; margin-right: 8px; position: relative; z-index: 1; }
    .step.pending .step-circle { background: #e5e7eb; color: var(--muted); }
    .step.active .step-circle { background: var(--brand); color: white; }
    .step.completed .step-circle { background: var(--ok); color: white; }
    .step-label { font-size: 14px; font-weight: 600; }
    .step.pending .step-label { color: var(--muted); }
    .step.active .step-label { color: var(--brand); }
    .step.completed .step-label { color: var(--ok); }

    /* Form Steps */
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .form-section { margin-bottom: 24px; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid var(--brd); }
    .form-section h2 { font-size: 1.15rem; font-weight: 700; margin: 0 0 14px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-12 { grid-column: 1 / -1; }
    label { display: block; font-weight: 700; color: var(--ink-2); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; background: #fff; }
    input:focus, select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }

    .roster-section { margin-bottom: 28px; }
    .roster-section h2 { font-size: 1.35rem; font-weight: 800; margin: 0 0 14px; position: relative; }
    .roster-section h2::after { content: ""; position: absolute; bottom: -6px; left: 0; width: 90px; height: 3px; background: var(--brand); }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
    th { background: #f8fafc; color: #374151; padding: 12px 10px; text-align: left; font-size: .8rem; text-transform: uppercase; letter-spacing: .4px; border-bottom: 2px solid #e5e7eb; }
    td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; } tr:nth-child(even) { background: #fbfcff; }
    .staff-row { background: #f0f9ff !important; }
    .jersey-input { text-align: center; font-weight: 700; }
    .duplicate { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Inline field error */
    .field-error { display:none; margin-top:6px; padding:10px 12px; border-radius:8px;
      background: var(--err-bg); border:1px solid var(--err-brd); color:#991b1b; font-weight:600; font-size:.9rem; }
    .input-error { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Bulk Operations */
    .bulk-ops { margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 12px; }
    .bulk-ops h3 { margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #0369a1; display: flex; align-items: center; gap: 8px; }
    
    .bulk-workflow { display: flex; gap: 24px; align-items: flex-start; margin-bottom: 16px; }
    .bulk-step { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
    .step-number { width: 28px; height: 28px; background: var(--brand); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; margin-top: 4px; }
    .step-content { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .step-content label { font-size: 14px; font-weight: 600; color: #1e40af; margin: 0; }
    .step-content small { color: #64748b; font-size: 12px; line-height: 1.3; }
    
    .bulk-select-all { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .bulk-select-all input { width: auto; margin: 0; }
    
    .bulk-select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; width: 100%; }
    .bulk-step .btn { margin-right: 8px; margin-bottom: 4px; padding: 8px 16px; font-size: 14px; }
    
    .bulk-status { padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; text-align: center; }
    .bulk-status span { font-weight: 600; color: var(--brand); }
    
    .selected-row { background-color: #dbeafe !important; border-left: 4px solid var(--brand) !important; }

    .status { display: none; padding: 12px 14px; border-radius: 10px; margin-bottom: 12px; font-weight: 600; }
    .status--warn { background: var(--err-bg); color: #991b1b; border: 1px solid var(--err-brd); }
    .status--ok { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

    .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn { padding: 12px 18px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: transform .12s ease, background .12s ease, opacity .12s ease; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-primary { background: var(--brand); color: #fff; } .btn-primary:hover:not(:disabled) { background: var(--brand-600); transform: translateY(-1px); }
    .btn-secondary { background: #6b7280; color: #fff; } .btn-secondary:hover:not(:disabled) { background: #4b5563; transform: translateY(-1px); }
    .btn-success { background: var(--ok); color: #fff; } .btn-success:hover:not(:disabled) { background: var(--ok-600); transform: translateY(-1px); }
    .btn-outline { background: transparent; color: var(--ink-2); border: 1px solid var(--brd); }

    .loading { display: none; text-align: center; color: var(--brand); font-weight: 800; margin-top: 10px; }
    .table-tools { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }

    .step-navigation { display: flex; justify-content: space-between; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--brd); }

    /* === DOUBLE-CLICK PREVENTION STYLES === */
    .form-submitting {
      pointer-events: none !important;
      user-select: none !important;
      position: relative;
    }

    .form-submitting::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      cursor: not-allowed;
    }

    .btn-submitting {
      background: #6b7280 !important;
      color: white !important;
      pointer-events: none !important;
      cursor: not-allowed !important;
      position: relative;
    }

    .btn-submitting::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .submission-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(3px);
    }

    .submission-modal {
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      max-width: 450px;
      margin: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalAppear 0.3s ease;
    }

    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .submission-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .submission-progress {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }

    .submission-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .submission-steps {
      text-align: left;
      margin-top: 25px;
      font-size: 14px;
    }

    .submission-step {
      display: flex;
      align-items: center;
      margin: 8px 0;
      color: #6b7280;
    }

    .submission-step.active {
      color: #3b82f6;
      font-weight: 600;
    }

    .submission-step.completed {
      color: #10b981;
    }

    .submission-step-icon {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .quick-message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 10001;
      animation: slideInRight 0.3s ease;
    }

    .quick-message.warning {
      background: #fbbf24;
      color: white;
    }

    .quick-message.info {
      background: #3b82f6;
      color: white;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @media (max-width: 900px) {
      .col-6, .col-4, .col-3 { grid-column: 1 / -1; }
      .container { padding: 18px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
      .bulk-workflow { flex-direction: column; gap: 16px; }
      .bulk-step { flex-direction: row; align-items: center; }
      .step-content { margin-left: 8px; }
      .steps { flex-direction: column; gap: 8px; }
      .step::after { display: none; }
      .submission-modal { margin: 10px; padding: 30px 20px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>üèÄ Basketligaen Team Roster Submission</h1>
    <p class="subtitle">Official roster form for Basketligaen teams ‚Ä¢ Powered by Pixellot Advantage</p>

    <div class="version-info" aria-live="polite">
      <span id="versionBadge" class="version">Version 3.24.0</span>
      <span class="date">Updated: August 2025 ‚Ä¢ Production Release</span>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 25%"></div>
      </div>
      <div class="steps">
        <div class="step active" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">Team Info</div>
        </div>
        <div class="step pending" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">Players</div>
        </div>
        <div class="step pending" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">Staff</div>
        </div>
        <div class="step pending" data-step="4">
          <div class="step-circle">4</div>
          <div class="step-label">Review</div>
        </div>
      </div>
    </div>

    <form id="rosterForm" novalidate>
      <!-- Step 1: Team Information -->
      <div class="form-step active" data-step="1">
        <section class="form-section" aria-labelledby="team-info-h">
          <h2 id="team-info-h">üèÜ Team Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="teamName">Team Name</label>
              <input id="teamName" name="teamName" type="text" placeholder="Enter your team name" autocomplete="organization" required />
            </div>
            <div class="col-6" style="display: none;">
              <label for="league">League</label>
              <select id="league" name="league">
                <option value="Basketligaen" selected>Basketligaen</option>
              </select>
            </div>
            <div class="col-6">
              <label for="season">Season</label>
              <select id="season" name="season" required></select>
            </div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="contact-h">
          <h2 id="contact-h">üìù Contact Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="submitterName">Your Name</label>
              <input id="submitterName" name="submitterName" type="text" placeholder="Enter your full name" autocomplete="name" required />
            </div>
            <div class="col-6">
              <label for="submitterEmail">Your Email</label>
              <input id="submitterEmail" name="submitterEmail" type="email" placeholder="Enter your email address" autocomplete="email" inputmode="email" required />
              <div id="submitterEmailError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Step 2: Players -->
      <div class="form-step" data-step="2">
        <section class="roster-section" aria-labelledby="players-h">
          <h2 id="players-h">üéØ Player Roster</h2>
          <div id="dupWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
          <div id="emailWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
          
          <!-- Bulk Operations -->
          <div class="bulk-ops">
            <h3>‚ö° Bulk Operations</h3>
            <div class="bulk-workflow">
              <div class="bulk-step">
                <span class="step-number">1</span>
                <div class="step-content">
                  <label class="bulk-select-all">
                    <input type="checkbox" id="selectAllPlayers">
                    <strong>Select Players</strong>
                  </label>
                  <small>Check individual players below or use "Select All"</small>
                </div>
              </div>
              
              <div class="bulk-step">
                <span class="step-number">2</span>
                <div class="step-content">
                  <label for="bulkPosition"><strong>Choose Position</strong></label>
                  <select id="bulkPosition" class="bulk-select">
                    <option value="">Choose position to apply...</option>
                    <option value="G">üèÉ‚Äç‚ôÇÔ∏è Guard (G)</option>
                    <option value="F">üèÄ Forward (F)</option>
                    <option value="C">üè¢ Center (C)</option>
                  </select>
                </div>
              </div>
              
              <div class="bulk-step">
                <span class="step-number">3</span>
                <div class="step-content">
                  <button type="button" class="btn btn-primary" id="applyBulkPosition">
                    ‚ú® Apply Position
                  </button>
                  <button type="button" class="btn btn-outline" id="clearSelected">
                    üóëÔ∏è Clear Selection
                  </button>
                </div>
              </div>
            </div>
            
            <div id="bulkStatus" class="bulk-status">
              <span id="selectionCount">0 players selected</span>
            </div>
          </div>

          <div class="table-tools">
            <button type="button" class="btn btn-outline" id="addRowBtn">+ Add Player</button>
            <button type="button" class="btn btn-outline" id="removeRowBtn">‚àí Remove Last</button>
            <span id="rowCountHelp" class="subtitle" aria-live="polite">0 rows</span>
          </div>
          
          <table aria-describedby="rowCountHelp">
            <thead>
              <tr>
                <th style="width:40px">Select</th>
                <th style="width:64px">S/N</th>
                <th style="width:90px">Jersey #</th>
                <th style="min-width:160px">First Name</th>
                <th style="min-width:160px">Last Name</th>
                <th style="width:90px">Height (CM)</th>
                <th style="width:100px">Position</th>
                <th style="min-width:220px">Email Address</th>
              </tr>
            </thead>
            <tbody id="playersTable"></tbody>
          </table>
        </section>
      </div>

      <!-- Step 3: Staff -->
      <div class="form-step" data-step="3">
        <section class="roster-section" aria-labelledby="staff-h">
          <h2 id="staff-h">üë®‚Äçüíº Coaching Staff</h2>
          <table>
            <thead>
              <tr>
                <th style="width:64px">S/N</th>
                <th style="width:140px">Role</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th style="width:100px">Position</th>
                <th>Email Address</th>
                <th style="width:140px">Phone</th>
              </tr>
            </thead>
            <tbody>
              <tr class="staff-row">
                <td>17</td>
                <td><strong>Head Coach</strong></td>
                <td><input type="text" name="coach_first" placeholder="First name" required /></td>
                <td><input type="text" name="coach_last" placeholder="Last name" required /></td>
                <td>-</td>
                <td><input type="email" name="coach_email" placeholder="Email" required /></td>
                <td><input type="tel" name="coach_phone" placeholder="Phone" inputmode="tel" required /></td>
              </tr>
              <tr class="staff-row">
                <td>18</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst1_first" placeholder="First name" /></td>
                <td><input type="text" name="asst1_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst1_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst1_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>19</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst2_first" placeholder="First name" /></td>
                <td><input type="text" name="asst2_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst2_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst2_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>20</td>
                <td><strong>Asst. Coach</strong></td>
                <td><input type="text" name="asst3_first" placeholder="First name" /></td>
                <td><input type="text" name="asst3_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="asst3_email" placeholder="Email" /></td>
                <td><input type="tel" name="asst3_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
              <tr class="staff-row">
                <td>21</td>
                <td><strong>GM</strong></td>
                <td><input type="text" name="gm_first" placeholder="First name" /></td>
                <td><input type="text" name="gm_last" placeholder="Last name" /></td>
                <td>-</td>
                <td><input type="email" name="gm_email" placeholder="Email" /></td>
                <td><input type="tel" name="gm_phone" placeholder="Phone" inputmode="tel" /></td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>

      <!-- Step 4: Review -->
      <div class="form-step" data-step="4">
        <section class="form-section">
          <h2>üìã Review Your Submission</h2>
          <div id="reviewContent"></div>
        </section>
      </div>

      <!-- Navigation Buttons -->
      <div class="step-navigation">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">‚Üê Previous</button>
        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear Form</button>
          <button type="button" class="btn btn-outline" id="saveBtn">üíæ Save Draft</button>
          <button type="button" class="btn btn-outline" id="restoreBtn">‚Ü© Restore Draft</button>
          <button type="button" class="btn btn-success" id="newBtn" style="display:none">üìã Create New Roster</button>
        </div>
        <button type="button" class="btn btn-primary" id="nextBtn">Next ‚Üí</button>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">üöÄ Submit Roster</button>
      </div>

      <div id="loading" class="loading">üîÑ Submitting your roster...</div>
      <div id="okMsg" class="status status--ok" role="status" aria-live="polite">‚úÖ Action complete.</div>
    </form>
  </div>

  <script>
    // === Configuration ===
    const EmailJSConfig = Object.freeze({
      publicKey: "_r4Y7hg0AGi5DhIcF",
      serviceId: "service_4bdvcf9",
      templateId: "template_6o8secn"
    });

    const DATA_SINK_URL = 'https://script.google.com/macros/s/AKfycbxchgyxazvH9t4N0prpLTboqeAlb6kRz6xUj-klQ1HIYtrZjs9qeKxWVqTttVJKdREj/exec';
    const DATA_SINK_KEY = 'Pixellot2@25';

    const APP_VERSION = '3.24.0';
    const BUILD_DATE = new Date().toISOString().slice(0,10);

    const CURRENT_SEASON_START_YEAR = 2025;
    const NEXT_SEASON_START_YEAR = 2026;
    const SWITCHOVER_DATE = new Date(2026, 7, 1);
    const FORCE_EXPOSE_NEXT_SEASON = false;

    const DEFAULT_PLAYER_ROWS = 16;
    const HARD_MAX_PLAYERS = 40;
    const STORAGE_KEY = "basketligaenRosterDraft_v3240";

    // === DOUBLE-CLICK PREVENTION GLOBALS ===
    let submissionState = {
      isSubmitting: false,
      lastSubmissionTime: 0,
      submissionId: null,
      currentStep: 0,
      steps: [
        { id: 'validate', text: 'Validating roster data' },
        { id: 'email', text: 'Sending confirmation email' },
        { id: 'save', text: 'Saving to database' },
        { id: 'download', text: 'Generating CSV file' }
      ]
    };

    const MIN_SUBMISSION_INTERVAL = 30000; // 30 seconds

    // === Multi-Step Navigation ===
    let currentStep = 1;
    const totalSteps = 4;

    // === Utility Functions (defined first) ===
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function generateSubmissionId() {
      return 'basketligaen_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function clean(s) { 
      return (s ?? '').toString().trim(); 
    }

    function normalizeDanish(str="") {
      return str
        .replace(/[√¶√Ü]/g, match => match === '√Ü' ? 'AE' : 'ae')
        .replace(/[√∏√ò]/g, match => match === '√ò' ? 'OE' : 'oe')
        .replace(/[√•√Ö]/g, match => match === '√Ö' ? 'AA' : 'aa')
        .replace(/[√§√Ñ]/g, match => match === '√Ñ' ? 'AE' : 'ae')
        .replace(/[√∂√ñ]/g, match => match === '√ñ' ? 'OE' : 'oe')
        .replace(/[√´√ã]/g, match => match === '√ã' ? 'E' : 'e')
        .replace(/[√º√ú]/g, match => match === '√ú' ? 'U' : 'u')
        .replace(/[√Ø√è]/g, match => match === '√è' ? 'I' : 'i');
    }

    function ucWords(str="") { 
      const normalized = normalizeDanish(str);
      return normalized.toLowerCase().replace(/\b\w/g, ch => ch.toUpperCase()); 
    }

    function ucName(s) { 
      return ucWords(clean(s)); 
    }

    function formatEmail(email) {
      if (!email) return '';
      return email.trim().toLowerCase();
    }

    function normJersey(val) {
      const n = parseInt(String(val).trim(), 10);
      return Number.isFinite(n) ? String(n) : '';
    }

    function seasonLabel(fromYear) {
      const toYear = (fromYear + 1).toString().slice(-2);
      return `${fromYear}/${toYear}`;
    }

    function positionToFullName(pos) {
      const map = { 'G': 'Guard', 'F': 'Forward', 'C': 'Center' };
      return map[pos] || pos;
    }

    function leagueToEnglish() {
      return 'Basketligaen';
    }

    // === Email Validation ===
    function emailValid(email) {
      const e = (email || '').trim().toLowerCase();
      if (!e) return { ok: true };
      
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return { ok: false };
      
      if (e.includes('..') || e.includes('@.') || e.includes('.@') || 
          e.startsWith('.') || e.endsWith('.') || 
          e.includes('@-') || e.includes('-@')) return { ok: false };
      
      const parts = e.split('@');
      if (parts.length !== 2) return { ok: false };
      
      const [localPart, domainPart] = parts;
      if (!localPart || !domainPart) return { ok: false };
      
      const domainParts = domainPart.split('.');
      if (domainParts.length < 2) return { ok: false };
      
      for (let i = 0; i < domainParts.length; i++) {
        if (!domainParts[i] || domainParts[i].length === 0) return { ok: false };
      }
      
      const tld = domainParts[domainParts.length - 1];
      if (tld.length < 2) return { ok: false };
      
      const typoMap = {
        '.con': '.com', '.cmo': '.com', '.ocm': '.com', '.cpm': '.com',
        '.ddk': '.dk', '.d': '.dk', '.dkk': '.dk',
        '@gamil.': '@gmail.', '@gmial.': '@gmail.', '@gmai.': '@gmail.',
        '@yahooo.': '@yahoo.', '@hotmial.': '@hotmail.', '@outlok.': '@outlook.'
      };
      
      for (const k in typoMap) {
        if (e.includes(k)) return { ok: false, suggestion: e.replace(k, typoMap[k]) };
      }
      
      return { ok: true };
    }

    // === Error Display Functions ===
    function showFieldError(inputEl, msg, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = msg;
        box.style.display = 'block';
      }
      if (inputEl) {
        inputEl.classList.add('input-error');
        inputEl.setAttribute('aria-invalid', 'true');
      }
    }

    function clearFieldError(inputEl, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = '';
        box.style.display = 'none';
      }
      if (inputEl) {
        inputEl.classList.remove('input-error');
        inputEl.removeAttribute('aria-invalid');
      }
    }

    function flashOk(msg) {
      const el = document.getElementById('okMsg');
      el.textContent = '‚úÖ ' + msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    function showQuickMessage(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'quick-message ' + type;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // === Season Management ===
    function populateSeasonSelect() {
      const sel = document.getElementById('season');
      sel.innerHTML = '';
      const seasons = [CURRENT_SEASON_START_YEAR];
      const exposeNext = FORCE_EXPOSE_NEXT_SEASON || (new Date() >= SWITCHOVER_DATE);
      if (exposeNext) seasons.push(NEXT_SEASON_START_YEAR);
      
      for (let i = 0; i < seasons.length; i++) {
        const y = seasons[i];
        const opt = document.createElement('option');
        opt.value = y + '-' + (y + 1);
        opt.textContent = seasonLabel(y);
        sel.appendChild(opt);
      }
      
      if (seasons.length > 0) {
        const def = exposeNext ? NEXT_SEASON_START_YEAR : CURRENT_SEASON_START_YEAR;
        sel.value = def + '-' + (def + 1);
      }
    }

    // === Progress Management ===
    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed', 'pending');
        
        if (stepNum < currentStep) {
          step.classList.add('completed');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else if (stepNum === currentStep) {
          step.classList.add('active');
          step.querySelector('.step-circle').textContent = stepNum;
        } else {
          step.classList.add('pending');
          step.querySelector('.step-circle').textContent = stepNum;
        }
      });
    }

    function showStep(step) {
      document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
      document.querySelector('.form-step[data-step="' + step + '"]').classList.add('active');
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.style.display = step > 1 ? 'block' : 'none';
      nextBtn.style.display = step < totalSteps ? 'block' : 'none';
      submitBtn.style.display = step === totalSteps ? 'block' : 'none';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (step === 4) {
        updateReviewContent();
      }
    }

    function nextStep() {
      if (!validateCurrentStep()) return;
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
        updateProgress();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }

    // === Player Table Functions ===
    function bumpRowCount() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      document.getElementById('rowCountHelp').textContent = rows + ' rows (max ' + HARD_MAX_PLAYERS + ')';
    }

    function playerRowTemplate(idx) {
      const sn = String(idx).padStart(2, '0');
      return '<tr data-player-row="' + idx + '">' +
        '<td><input type="checkbox" class="player-select" data-player="' + idx + '" /></td>' +
        '<td><strong>' + sn + '</strong></td>' +
        '<td><input type="number" min="0" max="99" step="1" name="player' + idx + '_jersey" class="jersey-input" placeholder="#" inputmode="numeric" /></td>' +
        '<td><input type="text" name="player' + idx + '_first" placeholder="First name" /></td>' +
        '<td><input type="text" name="player' + idx + '_last" placeholder="Last name" /></td>' +
        '<td><input type="number" min="100" max="999" step="1" name="player' + idx + '_height" placeholder="CM" inputmode="numeric" class="jersey-input" /></td>' +
        '<td><select name="player' + idx + '_position">' +
          '<option value="">-</option>' +
          '<option value="G">G</option>' +
          '<option value="F">F</option>' +
          '<option value="C">C</option>' +
        '</select></td>' +
        '<td><input type="email" name="player' + idx + '_email" placeholder="Email (optional)" /></td>' +
        '</tr>';
    }

    function ensureRows(count) {
      const tbody = document.getElementById('playersTable');
      tbody.innerHTML = '';
      const n = Math.min(HARD_MAX_PLAYERS, Math.max(1, count || 0));
      for (let i = 1; i <= n; i++) {
        tbody.insertAdjacentHTML('beforeend', playerRowTemplate(i));
      }
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      bumpRowCount();
    }

    function addRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr >= HARD_MAX_PLAYERS) return;
      tbody.insertAdjacentHTML('beforeend', playerRowTemplate(curr + 1));
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      bumpRowCount();
    }

    function removeRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr <= 1) return;
      tbody.removeChild(tbody.lastElementChild);
      bumpRowCount();
      checkDuplicates();
      updateSelectAllState();
    }

    // === Duplicate Detection ===
    let dupTimer;

    function hookDuplicateListeners() {
      const inputs = document.querySelectorAll('input[name*="_jersey"]');
      for (let i = 0; i < inputs.length; i++) {
        inputs[i].removeEventListener('input', dupHandler);
        inputs[i].addEventListener('input', dupHandler);
      }
    }

    function dupHandler() {
      clearTimeout(dupTimer);
      dupTimer = setTimeout(checkDuplicates, 350);
    }

    function checkDuplicates() {
      const jerseyInputs = document.querySelectorAll('input[name*="_jersey"]');
      const counts = {};
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v) counts[v] = (counts[v] || 0) + 1;
      });
      
      let hasDup = false;
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v && counts[v] > 1) { 
          inp.classList.add('duplicate'); 
          hasDup = true; 
        } else { 
          inp.classList.remove('duplicate'); 
        }
      });
      
      const warn = document.getElementById('dupWarn');
      if (hasDup) {
        warn.style.display = 'block';
        warn.textContent = '‚ö†Ô∏è Duplicate jersey numbers detected. Each player must have a unique number.';
      } else {
        warn.style.display = 'none';
        warn.textContent = '';
      }
    }

    // === Bulk Operations ===
    function hookBulkSelectionListeners() {
      const checkboxes = document.querySelectorAll('.player-select');
      for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].removeEventListener('change', handlePlayerSelectChange);
        checkboxes[i].addEventListener('change', handlePlayerSelectChange);
      }
    }

    function handlePlayerSelectChange() {
      updateRowSelection(this);
      updateSelectAllState();
    }

    function updateRowSelection(checkbox) {
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        row.classList.add('selected-row');
      } else {
        row.classList.remove('selected-row');
      }
    }

    function updateSelectAllState() {
      const allCheckboxes = document.querySelectorAll('.player-select');
      const checkedBoxes = document.querySelectorAll('.player-select:checked');
      const selectAllBox = document.getElementById('selectAllPlayers');
      const statusSpan = document.getElementById('selectionCount');
      
      statusSpan.textContent = checkedBoxes.length + ' player' + (checkedBoxes.length !== 1 ? 's' : '') + ' selected';
      
      if (checkedBoxes.length === 0) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = false;
      } else if (checkedBoxes.length === allCheckboxes.length) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = true;
      } else {
        selectAllBox.indeterminate = true;
        selectAllBox.checked = false;
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllPlayers');
      const checkboxes = document.querySelectorAll('.player-select');
      
      for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = selectAll.checked;
        updateRowSelection(checkboxes[i]);
      }
      
      updateSelectAllState();
    }

    function applyBulkPosition() {
      const selectedPosition = document.getElementById('bulkPosition').value;
      const selectedCheckboxes = document.querySelectorAll('.player-select:checked');
      
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one player first.');
        return;
      }
      
      if (!selectedPosition) {
        alert('Please select a position to apply.');
        return;
      }
      
      for (let i = 0; i < selectedCheckboxes.length; i++) {
        const playerNum = selectedCheckboxes[i].dataset.player;
        const positionSelect = document.querySelector('select[name="player' + playerNum + '_position"]');
        if (positionSelect) {
          positionSelect.value = selectedPosition;
        }
      }
      
      document.getElementById('bulkPosition').value = '';
      flashOk('Applied ' + selectedPosition + ' position to ' + selectedCheckboxes.length + ' player(s).');
    }

    function clearSelected() {
      const checkedBoxes = document.querySelectorAll('.player-select:checked');
      for (let i = 0; i < checkedBoxes.length; i++) {
        checkedBoxes[i].checked = false;
        updateRowSelection(checkedBoxes[i]);
      }
      updateSelectAllState();
    }

    // === Validation Functions ===
    function requireAtLeastOneCompletePlayer() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = document.querySelector('input[name="player' + i + '_jersey"]');
        const first = document.querySelector('input[name="player' + i + '_first"]');
        const last = document.querySelector('input[name="player' + i + '_last"]');
        const pos = document.querySelector('select[name="player' + i + '_position"]');
        const height = document.querySelector('input[name="player' + i + '_height"]');
        
        if (jersey && first && last && pos && height && 
            normJersey(jersey.value) && first.value.trim() && 
            last.value.trim() && pos.value && height.value.trim()) {
          return true;
        }
      }
      return false;
    }

    function validatePlayersCompleteness() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = document.querySelector('input[name="player' + i + '_jersey"]');
        const first = document.querySelector('input[name="player' + i + '_first"]');
        const last = document.querySelector('input[name="player' + i + '_last"]');
        const pos = document.querySelector('select[name="player' + i + '_position"]');
        const height = document.querySelector('input[name="player' + i + '_height"]');
        
        if (jersey && first && last && pos && height) {
          if (first.value.trim()) {
            if (!last.value.trim()) return { row: i, field: 'last name' };
            if (!pos.value) return { row: i, field: 'position' };
            if (!height.value.trim()) return { row: i, field: 'height' };
            if (!normJersey(jersey.value)) return { row: i, field: 'jersey number' };
          }
          
          const hasAny = normJersey(jersey.value) || first.value.trim() || 
                        last.value.trim() || pos.value || height.value.trim();
          const hasRequired = normJersey(jersey.value) && first.value.trim() && 
                             last.value.trim() && pos.value && height.value.trim();
          
          if (hasAny && !hasRequired) {
            return { row: i, field: 'complete player info (jersey, first name, last name, position, height)' };
          }
        }
      }
      return null;
    }

    function validateHeadCoach() {
      const coachFirst = document.querySelector('input[name="coach_first"]');
      const coachLast = document.querySelector('input[name="coach_last"]');
      const coachEmail = document.querySelector('input[name="coach_email"]');
      const coachPhone = document.querySelector('input[name="coach_phone"]');
      
      if (!coachFirst?.value.trim()) return 'Head coach first name is required';
      if (!coachLast?.value.trim()) return 'Head coach last name is required';
      if (!coachEmail?.value.trim()) return 'Head coach email is required';
      if (!coachPhone?.value.trim()) return 'Head coach phone is required';
      
      return null;
    }

    function validateStaffCompleteness() {
      const staffRoles = ['asst1', 'asst2', 'asst3', 'gm'];
      
      for (const role of staffRoles) {
        const first = document.querySelector(`input[name="${role}_first"]`);
        const last = document.querySelector(`input[name="${role}_last"]`);
        const email = document.querySelector(`input[name="${role}_email"]`);
        const phone = document.querySelector(`input[name="${role}_phone"]`);
        
        if (first && last && email && phone) {
          const hasAny = first.value.trim() || last.value.trim() || 
                        email.value.trim() || phone.value.trim();
          const hasAll = first.value.trim() && last.value.trim() && 
                        email.value.trim() && phone.value.trim();
          
          if (hasAny && !hasAll) {
            const roleName = role === 'asst1' ? 'Assistant Coach 1' :
                           role === 'asst2' ? 'Assistant Coach 2' :
                           role === 'asst3' ? 'Assistant Coach 3' : 'General Manager';
            return `${roleName} information is incomplete. All fields are required if any are filled.`;
          }
        }
      }
      return null;
    }

    function validateCurrentStep() {
      const currentStepEl = document.querySelector('.form-step[data-step="' + currentStep + '"]');
      const requiredFields = currentStepEl.querySelectorAll('[required]');
      
      // Check required fields
      for (const field of requiredFields) {
        if (!field.value.trim()) {
          field.focus();
          field.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return false;
        }
      }
      
      // Step 1: Email validation
      if (currentStep === 1) {
        const emailField = document.getElementById('submitterEmail');
        const raw = emailField.value;
        clearFieldError(emailField, 'submitterEmailError');

        const { ok, suggestion } = emailValid(raw);
        if (!ok && suggestion) {
          const useCorrection = confirm(`Email typo detected!\n\nDid you mean: ${suggestion}?`);
          if (useCorrection) {
            emailField.value = suggestion;
          } else {
            showFieldError(emailField, `Please correct your email. Suggested: ${suggestion}`, 'submitterEmailError');
            emailField.focus();
            return false;
          }
        } else if (!ok) {
          showFieldError(emailField, 'Please enter a valid email address.', 'submitterEmailError');
          emailField.focus();
          return false;
        }
      }
      
      // Step 2: Player validation
      if (currentStep === 2) {
        if (!requireAtLeastOneCompletePlayer()) {
          alert('Please add at least one complete player (jersey, first name, last name, position, height).');
          return false;
        }
        
        const validationError = validatePlayersCompleteness();
        if (validationError) {
          alert(`Player #${validationError.row} is missing required ${validationError.field}.`);
          return false;
        }
        
        checkDuplicates();
        if (document.getElementById('dupWarn').style.display === 'block') {
          alert('Resolve duplicate jersey numbers before continuing.');
          return false;
        }

        // Validate player emails
        const emailWarn = document.getElementById('emailWarn');
        emailWarn.style.display = 'none';
        
        const playerEmailInputs = document.querySelectorAll('input[name*="player"][name*="_email"]');
        for (const input of playerEmailInputs) {
          const v = input.value.trim();
          if (!v) continue;

          const { ok, suggestion } = emailValid(v);
          input.classList.remove('input-error');
          input.removeAttribute('aria-invalid');

          if (!ok && suggestion) {
            const useCorrection = confirm(`Player email typo detected!\n\nDid you mean: ${suggestion}?`);
            if (useCorrection) {
              input.value = suggestion;
            } else {
              emailWarn.textContent = `Please correct player email. Suggested: ${suggestion}`;
              emailWarn.style.display = 'block';
              input.focus();
              return false;
            }
          } else if (!ok) {
            emailWarn.textContent = 'Invalid player email address.';
            emailWarn.style.display = 'block';
            input.focus();
            return false;
          }
        }
      }
      
      // Step 3: Staff validation
      if (currentStep === 3) {
        const headCoachError = validateHeadCoach();
        if (headCoachError) {
          alert(headCoachError);
          return false;
        }
        
        const staffError = validateStaffCompleteness();
        if (staffError) {
          alert(staffError);
          return false;
        }
        
        // Validate staff emails
        const staffEmailInputs = document.querySelectorAll('input[name*="coach_email"], input[name*="asst"][name*="_email"], input[name*="gm_email"]');
        for (const input of staffEmailInputs) {
          const v = input.value.trim();
          if (!v) continue;

          const { ok, suggestion } = emailValid(v);
          if (!ok && suggestion) {
            const useCorrection = confirm(`Staff email typo detected!\n\nDid you mean: ${suggestion}?`);
            if (useCorrection) {
              input.value = suggestion;
            } else {
              input.focus();
              return false;
            }
          } else if (!ok) {
            alert('Invalid staff email address. Please correct it.');
            input.focus();
            return false;
          }
        }
      }
      
      return true;
    }

    // === Data Building ===
    function buildRoster(fd) {
      const roster = {
        teamName: clean(fd.get('teamName')),
        league: 'Basketligaen',
        leagueEnglish: 'Basketligaen',
        submitterName: ucName(fd.get('submitterName')),
        submitterEmail: formatEmail(clean(fd.get('submitterEmail'))),
        season: clean(fd.get('season')),
        players: [],
        staff: []
      };

      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = normJersey(fd.get(`player${i}_jersey`));
        const first = ucName(fd.get(`player${i}_first`));
        const last = ucName(fd.get(`player${i}_last`));
        const pos = clean(fd.get(`player${i}_position`));
        const email = formatEmail(clean(fd.get(`player${i}_email`)));
        const height = clean(fd.get(`player${i}_height`));
        
        if (jersey && first && last && pos) {
          roster.players.push({
            number: i,
            jersey: jersey,
            firstName: first,
            lastName: last,
            position: pos,
            email: email,
            height: height || ''
          });
        }
      }

      roster.players.sort((a, b) => parseInt(a.jersey, 10) - parseInt(b.jersey, 10));

      const staffRoles = [
        { key: 'coach', label: 'Head Coach' },
        { key: 'asst1', label: 'Assistant Coach 1' },
        { key: 'asst2', label: 'Assistant Coach 2' },
        { key: 'asst3', label: 'Assistant Coach 3' },
        { key: 'gm', label: 'General Manager' }
      ];
      
      for (const role of staffRoles) {
        const f = ucName(fd.get(`${role.key}_first`));
        const l = ucName(fd.get(`${role.key}_last`));
        const e = formatEmail(clean(fd.get(`${role.key}_email`)));
        const p = clean(fd.get(`${role.key}_phone`));
        
        if (f && l) {
          roster.staff.push({
            role: role.label,
            firstName: f,
            lastName: l,
            email: e,
            phone: p
          });
        }
      }

      return roster;
    }

    function rosterSummary(roster) {
      let out = 'BASKETLIGAEN TEAM ROSTER SUBMISSION\n==============================\n';
      out += `Team: ${roster.teamName}\n`;
      out += `League: ${roster.league} (${roster.leagueEnglish})\n`;
      out += `Season: ${roster.season}\n`;
      out += `Submitted by: ${roster.submitterName}\n`;
      out += `Email: ${roster.submitterEmail}\n`;
      out += `Date: ${new Date().toLocaleString()}\n`;
      out += `Version: ${APP_VERSION}\n\n`;
      
      out += 'CSV FORMAT FOR COPYING:\n=======================\n';
      for (const p of roster.players) {
        out += `${p.jersey},${p.firstName},${p.lastName},${p.email || ''},${p.position || ''}\n`;
      }
      
      out += `\nPLAYERS (${roster.players.length}):\n------------------------\n`;
      for (const p of roster.players) {
        const heightText = p.height ? ` | Height: ${p.height}` : '';
        const emailText = p.email ? ` | Email: ${p.email}` : '';
        out += `#${p.jersey} - Name: ${p.firstName} ${p.lastName} | Position: ${positionToFullName(p.position)}${heightText}${emailText}\n`;
      }
      
      out += `\nCOACHING STAFF (${roster.staff.length}):\n----------------------------\n`;
      for (const s of roster.staff) {
        out += `${s.role}: ${s.firstName} ${s.lastName}`;
        if (s.email) out += ` - ${s.email}`;
        if (s.phone) out += ` | ${s.phone}`;
        out += '\n';
      }
      return out;
    }

    // === Review Content ===
    function updateReviewContent() {
      const formData = new FormData(document.getElementById('rosterForm'));
      const roster = buildRoster(formData);
      
      function li(txt) { 
        const el = document.createElement('li'); 
        el.textContent = txt; 
        return el; 
      }

      const root = document.createElement('div');
      root.className = 'grid';
      
      const team = document.createElement('div');
      team.className = 'col-12';
      const h3a = document.createElement('h3'); 
      h3a.textContent = 'üèÜ Team Information';
      team.append(h3a);
      
      const info = [
        `Team: ${roster.teamName}`,
        `League: ${roster.league} (${roster.leagueEnglish})`,
        `Season: ${seasonLabel(parseInt(roster.season.split('-')[0], 10))}`,
        `Submitted by: ${roster.submitterName}`,
        `Email: ${roster.submitterEmail}`
      ];
      info.forEach(t => { 
        const p = document.createElement('p'); 
        p.textContent = t; 
        team.append(p); 
      });
      
      const players = document.createElement('div');
      players.className = 'col-6';
      const h3b = document.createElement('h3'); 
      h3b.textContent = `üéØ Players (${roster.players.length})`;
      players.append(h3b);
      
      if (roster.players.length) {
        const ul = document.createElement('ul'); 
        ul.style.margin = 0; 
        ul.style.paddingLeft = '20px';
        roster.players.forEach(p => {
          const heightText = p.height ? ` | Height: ${p.height}` : '';
          const emailText = p.email ? ` | Email: ${p.email}` : '';
          ul.append(li(`#${p.jersey} - Name: ${p.firstName} ${p.lastName} | Position: ${positionToFullName(p.position)}${heightText}${emailText}`));
        });
        players.append(ul);
      } else {
        const em = document.createElement('p'); 
        em.innerHTML = '<em>No players added</em>'; 
        players.append(em);
      }
      
      const staff = document.createElement('div');
      staff.className = 'col-6';
      const h3c = document.createElement('h3'); 
      h3c.textContent = `üë®‚Äçüíº Coaching Staff (${roster.staff.length})`;
      staff.append(h3c);
      
      if (roster.staff.length) {
        const ul = document.createElement('ul'); 
        ul.style.margin = 0; 
        ul.style.paddingLeft = '20px';
        roster.staff.forEach(s => {
          const parts = [`${s.role}: ${s.firstName} ${s.lastName}`];
          if (s.email) parts.push(s.email);
          if (s.phone) parts.push(s.phone);
          ul.append(li(parts.join(' - ')));
        });
        staff.append(ul);
      } else {
        const em = document.createElement('p'); 
        em.innerHTML = '<em>No staff added</em>'; 
        staff.append(em);
      }
      
      root.append(team, players, staff);
      document.getElementById('reviewContent').replaceChildren(root);
    }

    // === Draft Management ===
    function saveDraft() {
      const data = new FormData(document.getElementById('rosterForm'));
      const obj = { currentStep: currentStep };
      for (const [key, value] of data.entries()) {
        obj[key] = value;
      }
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        flashOk('Draft saved locally.');
      } catch (e) {
        alert('Failed to save draft. Your browser may have storage restrictions.');
      }
    }

    function restoreDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          alert('No draft found.');
          return;
        }
        
        const obj = JSON.parse(raw);
        
        if (obj.currentStep) {
          currentStep = obj.currentStep;
          showStep(currentStep);
          updateProgress();
        }
        
        const playerKeys = Object.keys(obj).filter(k => k.indexOf('player') === 0);
        const maxIdx = Math.max(1, Math.max(...playerKeys.map(k => {
          const match = k.match(/player(\d+)_/);
          return match ? parseInt(match[1], 10) : 1;
        })));
        
        ensureRows(Math.min(HARD_MAX_PLAYERS, Math.max(DEFAULT_PLAYER_ROWS, maxIdx)));
        
        for (const [k, v] of Object.entries(obj)) {
          if (k === 'currentStep') continue;
          const el = document.querySelector(`[name="${k}"]`);
          if (el) el.value = v;
        }
        
        bumpRowCount();
        checkDuplicates();
        flashOk('Draft restored.');
      } catch (e) {
        alert('Failed to restore draft. Data may be corrupted.');
      }
    }

    // === File Download ===
    function downloadCSV(roster) {
      const BOM = '\uFEFF';
      let csv = '';
      
      for (const p of roster.players) {
        csv += `${p.jersey},${p.firstName},${p.lastName},${p.email || ''},${p.position || ''}\n`;
      }
      
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `basketligaen_${roster.teamName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${roster.season}_roster_v${APP_VERSION}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === API Functions ===
    async function sendEmailViaAPI(params, options) {
      const url = 'https://api.emailjs.com/api/v1.0/email/send';
      
      const payload = {
        service_id: EmailJSConfig.serviceId,
        template_id: EmailJSConfig.templateId,
        user_id: EmailJSConfig.publicKey,
        template_params: params
      };
      
      const requestOptions = {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Request-ID': params.submission_id || Date.now().toString()
        },
        body: JSON.stringify(payload)
      };
      
      if (options?.signal) {
        requestOptions.signal = options.signal;
      }
      
      console.log('üìß Sending email with ID:', params.submission_id);
      
      const response = await fetch(url, requestOptions);
      
      if (!response.ok) {
        const errorText = await response.text().catch(() => 'Unknown error');
        throw new Error(`Email API failed (${response.status}): ${errorText}`);
      }
      
      return response;
    }

    async function sendToSheet(roster) {
      if (!DATA_SINK_URL) return true;
      
      const url = DATA_SINK_URL + '?key=' + encodeURIComponent(DATA_SINK_KEY);
      const payload = {
        app_version: APP_VERSION,
        build_date: BUILD_DATE,
        season: roster.season,
        team_name: roster.teamName,
        league: roster.league,
        league_english: roster.leagueEnglish,
        submitter_name: roster.submitterName,
        submitter_email: roster.submitterEmail,
        players: roster.players,
        staff: roster.staff
      };
      
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
          });
          return true;
        } catch (e) {
          if (attempt === 3) throw e;
          await new Promise(r => setTimeout(r, 400 * attempt));
        }
      }
    }

    // === DOUBLE-CLICK PREVENTION ===
    function lockdownUI() {
      const form = document.getElementById('rosterForm');
      const container = document.querySelector('.container');
      const submitBtn = document.getElementById('submitBtn');
      
      form.classList.add('form-submitting');
      container.style.pointerEvents = 'none';
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-submitting');
      submitBtn.innerHTML = '<span>Submitting...</span>';
      
      const inputs = form.querySelectorAll('input, select, button, textarea');
      inputs.forEach(input => {
        input.disabled = true;
        input.style.pointerEvents = 'none';
      });
      
      window.addEventListener('beforeunload', preventNavigation);
    }

    function unlockUI() {
      const form = document.getElementById('rosterForm');
      const container = document.querySelector('.container');
      const submitBtn = document.getElementById('submitBtn');
      
      form.classList.remove('form-submitting');
      container.style.pointerEvents = 'auto';
      
      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-submitting');
      submitBtn.innerHTML = 'üöÄ Submit Roster';
      
      const inputs = form.querySelectorAll('input, select, button, textarea');
      inputs.forEach(input => {
        input.disabled = false;
        input.style.pointerEvents = 'auto';
      });
      
      window.removeEventListener('beforeunload', preventNavigation);
    }

    function preventNavigation(e) {
      e.preventDefault();
      e.returnValue = 'Your roster is being submitted. Are you sure you want to leave?';
      return 'Your roster is being submitted. Are you sure you want to leave?';
    }

    function showSubmissionModal() {
      const existing = document.getElementById('submission-overlay');
      if (existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.id = 'submission-overlay';
      overlay.className = 'submission-overlay';
      
      overlay.innerHTML = `
        <div class="submission-modal">
          <div class="submission-spinner"></div>
          <h3 style="margin: 0 0 10px; color: #1f2937;">Submitting Your Roster</h3>
          <p style="margin: 0 0 20px; color: #6b7280;">Please don't close this window or navigate away</p>
          
          <div class="submission-progress">
            <div class="submission-progress-bar" id="progress-bar" style="width: 0%"></div>
          </div>
          
          <div class="submission-steps" id="submission-steps">
            ${submissionState.steps.map(step => `
              <div class="submission-step" id="step-${step.id}">
                <div class="submission-step-icon" id="icon-${step.id}">
                  <div class="pulse-dot"></div>
                </div>
                <span>${step.text}</span>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top: 25px; font-size: 12px; color: #9ca3af;">
            Submission ID: <code>${submissionState.submissionId}</code>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    }

    function updateSubmissionProgress() {
      const progress = ((submissionState.currentStep + 1) / submissionState.steps.length) * 100;
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
        progressBar.style.width = progress + '%';
      }
      
      submissionState.steps.forEach((step, index) => {
        const stepEl = document.getElementById(`step-${step.id}`);
        const iconEl = document.getElementById(`icon-${step.id}`);
        
        if (!stepEl || !iconEl) return;
        
        if (index < submissionState.currentStep) {
          stepEl.className = 'submission-step completed';
          iconEl.innerHTML = '‚úì';
        } else if (index === submissionState.currentStep) {
          stepEl.className = 'submission-step active';
          iconEl.innerHTML = '<div class="pulse-dot"></div>';
        } else {
          stepEl.className = 'submission-step';
          iconEl.innerHTML = '<div style="width:8px;height:8px;background:#e5e7eb;border-radius:50%;"></div>';
        }
      });
    }

    function hideSubmissionModal() {
      const overlay = document.getElementById('submission-overlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 300);
      }
    }

    async function updateStep(stepId, action) {
      submissionState.currentStep = submissionState.steps.findIndex(s => s.id === stepId);
      updateSubmissionProgress();
      
      await action();
      
      const stepEl = document.getElementById(`step-${stepId}`);
      const iconEl = document.getElementById(`icon-${stepId}`);
      if (stepEl && iconEl) {
        stepEl.className = 'submission-step completed';
        iconEl.innerHTML = '‚úì';
      }
    }

    async function processSubmission() {
      const form = document.getElementById('rosterForm');
      const fd = new FormData(form);
      
      try {
        // Step 1: Validation
        await updateStep('validate', async () => {
          console.log('üìã Validating data...');
          
          const submitEmail = fd.get('submitterEmail');
          if (submitEmail) {
            const { ok: okEmail, suggestion } = emailValid(submitEmail);
            if (!okEmail && suggestion) {
              const use = confirm(`Did you mean "${suggestion}"?`);
              if (use) {
                document.getElementById('submitterEmail').value = suggestion;
                fd.set('submitterEmail', suggestion);
              } else {
                throw new Error('Email validation failed');
              }
            } else if (!okEmail) {
              throw new Error('Invalid email address');
            }
          }
          
          await delay(1000);
        });
        
        const roster = buildRoster(fd);
        const submissionParams = {
          submission_id: submissionState.submissionId,
          team_name: roster.teamName,
          league: roster.leagueEnglish,
          submitter_name: roster.submitterName,
          submitter_email: roster.submitterEmail,
          season: roster.season,
          roster_data: rosterSummary(roster),
          timestamp: new Date().toISOString()
        };
        
        // Step 2: Send Email
        await updateStep('email', async () => {
          console.log('üìß Sending email...');
          
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 20000);
          
          try {
            await sendEmailViaAPI(submissionParams, { signal: controller.signal });
            console.log('‚úÖ Email sent successfully');
          } finally {
            clearTimeout(timeout);
          }
        });
        
        // Step 3: Save Data
        await updateStep('save', async () => {
          console.log('üíæ Saving data...');
          
          try {
            await sendToSheet(roster);
            console.log('‚úÖ Data saved successfully');
          } catch (error) {
            console.warn('‚ö†Ô∏è Data save failed, continuing anyway:', error);
          }
        });
        
        // Step 4: Generate File
        await updateStep('download', async () => {
          console.log('üìÅ Generating file...');
          downloadCSV(roster);
          await delay(1000);
          console.log('‚úÖ File generated');
        });
        
        showSubmissionSuccess();
        
      } catch (error) {
        console.error('üí• Process failed:', error);
        throw error;
      }
    }

    function showSubmissionSuccess() {
      hideSubmissionModal();
      unlockUI();
      
      const ok = document.getElementById('okMsg');
      ok.textContent = '‚úÖ Roster submitted successfully! Email sent and CSV downloaded.';
      ok.style.display = 'block';
      document.getElementById('newBtn').style.display = 'inline-block';
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.classList.remove('btn-submitting');
      submitBtn.classList.add('btn-success');
      submitBtn.innerHTML = '‚úÖ Successfully Submitted';
      submitBtn.disabled = true;
    }

    function handleSubmissionError(error) {
      hideSubmissionModal();
      unlockUI();
      
      submissionState.isSubmitting = false;
      
      alert(`Submission failed: ${error.message}\n\nPlease try again or contact support.\n\nSubmission ID: ${submissionState.submissionId}`);
      
      console.error('Submission error details:', {
        submissionId: submissionState.submissionId,
        error: error,
        timestamp: new Date().toISOString()
      });
    }

    function setupImprovedSubmissionHandler() {
      const form = document.getElementById('rosterForm');
      
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);
      
      document.getElementById('rosterForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('üöÄ Submit attempt at:', new Date().toISOString());
        
        const now = Date.now();
        
        if (submissionState.isSubmitting) {
          console.log('‚ùå Already submitting, blocked');
          showQuickMessage('Submission already in progress!', 'warning');
          return false;
        }
        
        if (now - submissionState.lastSubmissionTime < MIN_SUBMISSION_INTERVAL) {
          const waitTime = Math.ceil((MIN_SUBMISSION_INTERVAL - (now - submissionState.lastSubmissionTime)) / 1000);
          console.log(`‚ùå Too soon, blocked. Wait ${waitTime} seconds`);
          showQuickMessage(`Please wait ${waitTime} more seconds before submitting again.`, 'warning');
          return false;
        }
        
        submissionState.isSubmitting = true;
        submissionState.lastSubmissionTime = now;
        submissionState.submissionId = generateSubmissionId();
        submissionState.currentStep = 0;
        
        console.log('‚úÖ Submission started with ID:', submissionState.submissionId);
        
        lockdownUI();
        showSubmissionModal();
        
        try {
          await processSubmission();
        } catch (error) {
          console.error('üí• Submission failed:', error);
          handleSubmissionError(error);
        } finally {
          setTimeout(() => {
            submissionState.isSubmitting = false;
          }, 5000);
        }
      });
    }

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('versionBadge').textContent = 'Version ' + APP_VERSION;

      populateSeasonSelect();
      ensureRows(DEFAULT_PLAYER_ROWS);
      updateProgress();
      
      setupImprovedSubmissionHandler();
      
      // Event listeners
      document.getElementById('nextBtn').addEventListener('click', nextStep);
      document.getElementById('prevBtn').addEventListener('click', prevStep);
      document.getElementById('addRowBtn').addEventListener('click', addRow);
      document.getElementById('removeRowBtn').addEventListener('click', removeRow);
      document.getElementById('selectAllPlayers').addEventListener('change', toggleSelectAll);
      document.getElementById('applyBulkPosition').addEventListener('click', applyBulkPosition);
      document.getElementById('clearSelected').addEventListener('click', clearSelected);

      // Email validation
      const submitterEmailInput = document.getElementById('submitterEmail');
      submitterEmailInput.addEventListener('input', function() { 
        clearFieldError(this, 'submitterEmailError'); 
      });
      submitterEmailInput.addEventListener('blur', function() {
        const { ok, suggestion } = emailValid(this.value);
        if (!ok && !suggestion) {
          showFieldError(this, 'Please enter a valid email address.', 'submitterEmailError');
        }
      });

      // Clear email warnings on edit
      document.addEventListener('input', function(e) {
        if (e.target?.name?.endsWith('_email')) {
          e.target.classList.remove('input-error');
          e.target.removeAttribute('aria-invalid');
          const emailWarn = document.getElementById('emailWarn');
          if (emailWarn) { 
            emailWarn.style.display = 'none'; 
            emailWarn.textContent = ''; 
          }
        }
      });

      // Clear form
      document.getElementById('clearBtn').addEventListener('click', function() {
        if (!confirm('Clear all data (except your name/email if present)?')) return;
        
        const keepName = document.getElementById('submitterName').value;
        const keepEmail = document.getElementById('submitterEmail').value;
        
        document.getElementById('rosterForm').reset();
        ensureRows(DEFAULT_PLAYER_ROWS);
        populateSeasonSelect();
        
        document.getElementById('submitterName').value = keepName;
        document.getElementById('submitterEmail').value = keepEmail;
        
        document.getElementById('dupWarn').style.display = 'none';
        document.getElementById('okMsg').style.display = 'none';
        document.getElementById('emailWarn').style.display = 'none';
        document.getElementById('submitterEmailError').style.display = 'none';
        document.getElementById('newBtn').style.display = 'none';
        
        currentStep = 1;
        showStep(currentStep);
        updateProgress();
        
        submissionState.isSubmitting = false;
        submissionState.lastSubmissionTime = 0;
        setupImprovedSubmissionHandler();
      });
      
      // New roster
      document.getElementById('newBtn').addEventListener('click', function() {
        const keepName = document.getElementById('submitterName').value;
        const keepEmail = document.getElementById('submitterEmail').value;
        
        document.getElementById('rosterForm').reset();
        ensureRows(DEFAULT_PLAYER_ROWS);
        populateSeasonSelect();
        
        document.getElementById('submitterName').value = keepName;
        document.getElementById('submitterEmail').value = keepEmail;
        
        document.getElementById('dupWarn').style.display = 'none';
        document.getElementById('okMsg').style.display = 'none';
        document.getElementById('emailWarn').style.display = 'none';
        document.getElementById('submitterEmailError').style.display = 'none';
        document.getElementById('newBtn').style.display = 'none';
        
        currentStep = 1;
        showStep(currentStep);
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        submissionState.isSubmitting = false;
        submissionState.lastSubmissionTime = 0;
        setupImprovedSubmissionHandler();
      });

      document.getElementById('saveBtn').addEventListener('click', saveDraft);
      document.getElementById('restoreBtn').addEventListener('click', restoreDraft);
      
      console.log('üõ°Ô∏è Basketligaen Form with double-click prevention initialized');
    });
  </script>
</body>
</html>
